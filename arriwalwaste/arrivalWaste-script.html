<script>


  const aWForm = new AWFormBuilder('aw', '#AwMainForma', '[data-form-fin-main]');
  aWForm.render();

  const formDataHandler = new FormDataFromTables('[data-form-aw]');

  // Обробка натискання клавіші Enter
  function clickPressAW(event) {
    if (event.keyCode == 13) {
      btnSaveModalAW();
    }
  }

  // Обробка натискання Enter для витрат Приват
  function clickPressAwPrivat(event) {
    if (event.keyCode == 13) {
      buttonClickWaste();
    }
  }

  function startArrivalWasteClear() {
    $("#firmaArrivalWaste-datalist").empty();
    $("#waste-datalist").empty();
  }

  // Отримання списку статей для випадаючого меню
  function getDropDownArrayStatyaArrivalWaste() {
    const storageDataArrival = localStorage.getItem('dataArrival');
    const storageDataAWaste = localStorage.getItem('dataWaste');
    if (!storageDataArrival || !storageDataAWaste) return false;
    const dohod = (JSON.parse(storageDataArrival).data).map(x => [x[4]]);
    const rashod = (JSON.parse(storageDataAWaste).data).map(x => [x[3]]);
    const dohodRashod = [...new Set(rashod.concat(dohod).filter(String).flat())];
    const stopAw = JSON.parse(localStorage.getItem('stopAw'));
    return searchingSubstringInArrayStrings(dohodRashod, stopAw, 0);
  }

  function startArrivalWaste() {
    startArrivalWasteClear();
    afterDropDownReturned(getDropDownArrayOnline('dataArrival', 3), "firmaArrivalWaste-datalist");
    afterDropDownReturned(getDropDownArrayStatyaArrivalWaste(), "waste-datalist");
  }

  // Встановлення значення costPrivat
  document.querySelector('#costPrivat').value = +localStorage.getItem('costPrivat');

  // Збирання даних з форми за допомогою FormDataFromTables
  function getFormDataArrivalWaste() {
    const formData = formDataHandler.formaDataObj();
    let { date, summa, summaPrivat, costPrivat, forma, firmaArrivalWaste, waste, termkar } = formData;

    summa = Math.abs(+summa || 0);
    summaPrivat = +summaPrivat || 0;
    costPrivat = +costPrivat || 0;

    if (!summaPrivat && !summa) {
      summa = "";
      waste = "Не заповнено ні одного поля суми";
      firmaArrivalWaste = "";
    }

    if (summaPrivat && !summa) {
      if (!costPrivat) {
        waste = "Не заповнено вартості комісії приват";
      } else {
        localStorage.setItem('costPrivat', costPrivat);
        summa = summaPrivat * costPrivat;
        waste = "Приват комісія";
        forma = "тов";
        firmaArrivalWaste = "";
      }
    }

    return [date, +summa, forma, firmaArrivalWaste, waste, termkar];
  }

  function buttonClickWasteAndArival() {
    const termkarVal = document.getElementById("termkar").value;
    const formData = getFormDataArrivalWaste();

    if (!formData[4] && !termkarVal) {
      alert('Не заповнена стаття витрат');
      return;
    }

    if (formData[4] === "Не заповнено ні одного поля суми") {
      alert("Не заповнено ні одного поля суми");
      return false;
    }
    if (formData[4] === "Заповнені обидва поля суми") {
      alert("Заповнені обидва поля суми");
      return false;
    }
    if (formData[4] === "Не заповнено вартості комісії приват") {
      alert("Не заповнено вартості комісії приват");
      return false;
    }
    if (formData[4] === "Не заповнена ціна привату") {
      alert("Не заповнена ціна привату");
      return false;
    }

    startArrivalWaste();
    if (this.id === "buttonWaste") {
      spinner("dataTableArriwalWaste");
      if (!formData[5]) {
        google.script.run
          .withSuccessHandler(createTableArriwalWaste)
          .addNewRowWaste(formData.slice(0, 5));
      } else {
        google.script.run.insertTermKar(rowDataTermKar());
        google.script.run
          .withSuccessHandler(startDataWaste)
          .vReestrTerminalKarantin(rowDataTermKar());
      }
      document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші витрати";
      buttonClickOchistkaAW();
    }
    if (this.id === "buttonArrival") {
      spinner("dataTableArriwalWaste");
      google.script.run
        .withSuccessHandler(createTableArriwalWaste)
        .addNewRowArrival(formData.slice(0, 5));
      document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші надходження";
      google.script.run
        .withSuccessHandler(createTableArriwalWaste)
        .addNewTableArriwal(formData.slice(0, 5));
      buttonClickOchistkaAW();
    }
    document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
  }

  function buttonClickOchistkaAW() {
    formDataHandler.clearRecords();
  }

  // Обробка кнопок "вчора", "п'ятниця", "сьогодні"
  document.querySelectorAll(".btn-yft").forEach(elem => {
    const date = document.querySelector("#date");
    elem.addEventListener('click', e => {
      yesterdayFridayToday1(e.target.value, date);
    });
  });

  // Прив'язка подій до кнопок
  // document.getElementById("buttonWaste").addEventListener("click", buttonClickWasteAndArival);
  // document.getElementById("buttonArrival").addEventListener("click", buttonClickWasteAndArival);
  document.getElementById("buttonWasteTab").addEventListener("click", startDataWaste);
  document.getElementById("buttonArrivalTab").addEventListener("click", startDataArriwal);

  document.getElementById("date").valueAsDate = new Date();

  function startDataWaste() {
    spinner("dataTableArriwalWaste");
    document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші витрати";
    createTableArriwalWaste(JSON.parse(localStorage.getItem('dataWaste')));
    document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
    startArrivalWaste();
  }

  function startDataArriwal() {
    spinner("dataTableArriwalWaste");
    document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші надходження";
    createTableArriwalWaste(JSON.parse(localStorage.getItem('dataArrival')));
    document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
    startArrivalWaste();
  }

  // Побудова таблиці
  const buildTableAw = dataArray => {
    if (dataArray) {
      let result = `<table class='table table-bordered table-hover table-line-selection' id='table-aw' style='table-layout: auto;'>`;
      const dataArrayData = dataArray;
      if (dataArrayData[0]) {
        const numId = +dataArrayData[0].length - 1;
        for (let i = dataArrayData.length - 1; i >= 0; i--) {
          result += "<tr>";
          for (let j = 0; j < dataArrayData[i].length; j++) {
            if (j === numId) continue;
            result += "<td>" + dataArrayData[i][j] + "</td>";
          }
          result += `<td>
          <button type="button" id="buttonModalFinance${dataArrayData[i][numId]}" class="btn btn-sm btn-light btnbtn" data-bs-toggle="modal" data-bs-target="#exampleModal">Edit</button>
        </td>`;
        }
        result += `</tr></table>`;
        clickTables('#table-aw', () => {
          if (event.target.tagName !== 'TD') return false;
          const dataTarget = event.target.textContent;
          document.querySelector('#search').value = dataTarget;
        });
      }
      return result;
    }
  };

  // Відкриття модального вікна
  function btnOpenModal(arr, id) {
    const row = Number(id.match(/\d+/));
    const allModal = arr.filter(el => Number(el[+arr[0].length - 1]) === Number(row)).flat();
    const dateModal = formatDateYYYYtireMMtireDD(strongToDate(allModal[0]));
    const summaModal = strongToNumber(allModal[1]);
    let fIrmaModal = arr[0].length === 6 ? allModal[3] : '';
    let wasteModal = arr[0].length === 6 ? allModal[4] : allModal[3];
    const formaModal = allModal[2];

    $("#exampleModal").on("shown.bs.modal", () => {
      $("#dateModal").val(dateModal);
      $("#summaModal").val(summaModal);
      $("#formaModal").val(formaModal);
      $("#firmaArrivalWasteModal").val(fIrmaModal);
      $("#wasteModal").val(wasteModal);
      $("#awModalLabel").text(row + 2);
    });
  }

  // Рендеринг таблиці
  function createTableArriwalWaste(dataArray) {
    const div = document.getElementById("dataTableArriwalWaste");
    if (!dataArray || !dataArray.data) {
      alert('storage пустий');
      return false;
    }

    const searhValueNode = document.querySelector('#search');
    searchValueAw();
    searhValueNode.addEventListener('click', searchValueAw);
    searhValueNode.addEventListener('keyup', searchValueAw);
    searhValueNode.addEventListener('input', searchValueAw);

    function searchValueAw() {
      if (!$("#vrabotevseArriwalWaste").text()) return;
      const dataSearchValue = searhValueNode.value;
      div.innerHTML = dataSearchValue
        ? buildTableAw(findInTable(dataArray.data, dataSearchValue))
        : buildTableAw(dataArray.data);

      $(".btnbtn").click(function () {
        btnOpenModal(dataArray.data, this.id);
      });

      clickTables('#table-aw', searchToClick);
    }

    autoSearchOnOpen(".input-search");

    google.script.run.withSuccessHandler((data) => {
      localStorage.setItem('dataWaste', JSON.stringify(data));
      document.querySelector('#buttonWasteTab').disabled = false;
    }).getLastTenRowsWaste();

    google.script.run.withSuccessHandler((data) => {
      localStorage.setItem('dataCashe', JSON.stringify(data));
    }).getDropDownArrayCashe();

    function searchToClick() {
      if (event.target.tagName !== 'TD') return false;
      const dataTarget = event.target.textContent;
      document.querySelector('#search').value = dataTarget;
    }
    clickTables('#table-aw', searchToClick);
  }

  // Термінал-карантин
  function rowDataTermKar() {
    const formData = formDataHandler.formaDataObj();
    return [
      formData.date,
      +formData.summa,
      formData.forma,
      formData.waste,
      formData.termkar,
      formData.sftermkar,
    ];
  }

  // Видалення запису в модальному вікні
  $("#btnDeleteModalAW").on("click", () => {
    if (!window.confirm("Удалить запись?")) return;
    const id = $("#awModalLabel").text();
    if ($("#vrabotevseArriwalWaste").text() === "Інші надходження") {
      google.script.run
        .withSuccessHandler(startDataArriwal)
        .deleteRowArriwalModal(id);
    } else if ($("#vrabotevseArriwalWaste").text() === "Інші витрати") {
      google.script.run
        .withSuccessHandler(startDataWaste)
        .deleteRowWasteModal(id);
    } else {
      alert('Перевірь function btnSaveModalAW()');
    }
  });

  // Збереження в модальному вікні
  $("#btnSaveModalAW").on("click", btnSaveModalAW);
  function btnSaveModalAW() {
    const id = $("#awModalLabel").text();
    const data = [[
      $("#dateModal").val(),
      +$("#summaModal").val(),
      $("#formaModal").val(),
      $("#firmaArrivalWasteModal").val(),
      $("#wasteModal").val(),
    ]];

    $("#exampleModal").modal("hide");
    if ($("#vrabotevseArriwalWaste").text() === "Інші надходження") {
      google.script.run
        .withSuccessHandler(() => {
          google.script.run.withSuccessHandler((data) => {
            localStorage.setItem('dataArrival', JSON.stringify(data));
            startDataArriwal();
          }).getLastTenRowsArriwal();
        })
        .changesRowArriwalModal(id, data);
    } else if ($("#vrabotevseArriwalWaste").text() === "Інші витрати") {
      google.script.run
        .withSuccessHandler(() => {
          google.script.run.withSuccessHandler((data) => {
            localStorage.setItem('dataWaste', JSON.stringify(data));
            startDataWaste();
          }).getLastTenRowsWaste();
        })
        .changesRowWasteModal(id, data);
    } else {
      alert('Перевірь function btnSaveModalAW()');
    }
  }

  // Спостерігач за змінами для суми
  const mutationObserverAw = () => {
    const observer = new MutationObserver(mutations => {
      mutations.forEach(() => {
        const searsh = document.querySelector('#search');
        const summa = document.querySelector('#vrabotevse-arriwalwaste-summa');
        summaTrFiltered('#dataTableArriwalWaste', '#vrabotevse-arriwalwaste-summa');
        if (!searsh.value || !document.getElementById('dataTableArriwalWaste').hasChildNodes() || summa.innerHTML === 'Разом: 0.00 грн') {
          summa.innerHTML = '';
        }
      });
    });
    observer.observe(document.getElementById('dataTableArriwalWaste'), {
      attributes: true,
      childList: true,
      subtree: true
    });
  };
  mutationObserverAw();

  // Колір для costPrivat
  const costPrivatColor = () => {
    const costpriv = document.querySelector('#costPrivat');
    if (!+costpriv.value) {
      costpriv.style.backgroundColor = '#dc35457a';
    } else {
      costpriv.style.removeProperty('background-color');
    }
    costpriv.addEventListener('input', costPrivatColor);
  };
  costPrivatColor();

</script>