<script>

  fromTemplateArw('#for-template-aw');

  // cрабатывание по кнопке Enter
  function clickPressAW(event) {
    if (event.keyCode == 13) {
      btnSaveModalAW();
    }
  }

  // cрабатывание по кнопке Enter для ввода данных по тратам Приват при заполненном поле "Приват"
  function clickPressAwPrivat(event) {
    if (event.keyCode == 13) {
      buttonClickWaste();
    }
  }

  function startArrivalWasteClear() {
    document.getElementById("firmaArrivalWaste-datalist").innerText = '';
    document.getElementById("waste-datalist").innerText = '';
  }

  function startArrivalWaste() {
    startArrivalWasteClear();

    google.script.run
      .withSuccessHandler((arrayOfArrays) => {
        afterDropDownReturned(arrayOfArrays, "firmaArrivalWaste-datalist");
      })
      .getDropDownArrayFirmaArrivalWaste();

    google.script.run
      .withSuccessHandler((arrayOfArrays) => {
        afterDropDownReturned(arrayOfArrays, "waste-datalist");
      })
      .getDropDownArrayStatyaArrivalWaste();
  }

  function rowDataRangeArrivalWaste() {
    const date = document.querySelector(".date-aw").value;
    let summa = +document.querySelector(".summa-aw").value;
    const summaPrivat = +document.querySelector(".summaPrivat-aw").value;
    let forma = document.querySelector(".forma-aw").value;
    let firmaArrivalWaste = document.querySelector(".firmaArrivalWaste-aw").value;
    let waste = document.querySelector(".waste-aw").value;
    if (!summaPrivat && !summa) {
      summa = "";
      waste = "Не заполнено ни одно поле суммы";
      firmaArrivalWaste = "";
    }
    if (summaPrivat && summa) {
      waste = "Заполнены оба поля суммы";
      firmaArrivalWaste = "";
      summa = "";
      summaPrivat = "";
    }
    if (summaPrivat && !summa) {
      summa = summaPrivat * 3;
      waste = "Приват комиссия";
      forma = "ооо";
      firmaArrivalWaste = "";
    }

    const rowData = [date, +summa, forma, firmaArrivalWaste, waste];
    return rowData;
  }

  function buttonClickWasteAndArival() {
    let vrabotevseArriwalWaste = document.getElementById(
      "vrabotevseArriwalWaste"
    );
    if (rowDataRangeArrivalWaste()[4] === "Не заполнено ни одно поле суммы") {
      alert("Не заполнено ни одно поле суммы");
      return false;
    }
    if (rowDataRangeArrivalWaste()[4] === "Заполнены оба поля суммы") {
      alert("Заполнены оба поля суммы");
      return false;
    }
    startArrivalWaste();
    if (this.id === "buttonWaste") {
      spinner("dataTableArriwalWaste");
      if (!rowDataTermKar()[4]) {
        google.script.run
          .withSuccessHandler(createTableArriwalWaste)
          .addNewRowWaste(rowDataRangeArrivalWaste());
      } else {
        google.script.run.insertTermKar(rowDataTermKar());
        google.script.run
          .withSuccessHandler(createTableArriwalWaste)
          .vReestrTerminalKarantin(rowDataTermKar());
      }
      vrabotevseArriwalWaste.innerHTML = "Прочие траты";
      google.script.run
        .withSuccessHandler(createTableArriwalWaste)
        .addNewTableWaste(rowDataRangeArrivalWaste());
      buttonClickOchistkaAW();
    }
    if (this.id === "buttonArrival") {
      if (rowDataRangeArrivalWaste()[4] === "Приват комиссия") {
        alert(
          'Запонено поле "Приват комиссия", не корректная операция прихода'
        );
        return false;
      }
      spinner("dataTableArriwalWaste");
      google.script.run
        .withSuccessHandler(createTableArriwalWaste)
        .addNewRowArrival(rowDataRangeArrivalWaste());
      vrabotevseArriwalWaste.innerHTML = "Прочие поступления";
      google.script.run
        .withSuccessHandler(createTableArriwalWaste)
        .addNewTableArriwal(rowDataRangeArrivalWaste());
      buttonClickOchistkaAW();
    }
  }

  function buttonClickOchistkaAW() {
    document.("summa-aw").value = "";
    document.getElementsByClassName("summaPrivat-aw").value = "";
    document.getElementsByClassName("firmaArrivalWaste-aw").value = "";
    document.getElementsByClassName("waste-aw").value = "";
    document.getElementsByClassName("termkar-aw").value = "";
    document.getElementsByClassName("sftermkar-aw").value = "";
  }

  document
    .getElementById("buttonWaste")
    .addEventListener("click", buttonClickWasteAndArival);
  document
    .getElementById("buttonArrival")
    .addEventListener("click", buttonClickWasteAndArival);
  document
    .getElementById("buttonWasteTab")
    .addEventListener("click", startDataWaste);
  document
    .getElementById("buttonArrivalTab")
    .addEventListener("click", startDataArriwal);
  document.querySelector(".date-aw").valueAsDate = new Date();

  function startDataWaste() {
    spinner("dataTableArriwalWaste");
    google.script.run
      .withSuccessHandler(createTableArriwalWaste)
      .getLastTenRowsWaste();
    document.getElementById("vrabotevseArriwalWaste").innerHTML =
      "Прочие траты";
    //   document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
    startArrivalWaste();
  }

  function startDataArriwal() {
    spinner("dataTableArriwalWaste");
    google.script.run
      .withSuccessHandler(createTableArriwalWaste)
      .getLastTenRowsArriwal();
    document.getElementById("vrabotevseArriwalWaste").innerHTML =
      "Прочие поступления";
    //  document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
    startArrivalWaste();
  }

  /* function createTableArriwalWaste(dataArray) {

  const nameTable = dataArray.data.slice()
  if(dataArray.data){
    var result = "<table class='table table-bordered' style='font-size:0.9em'>"
      // строим таблицу
      for(var i=1; i<dataArray.data.length; i++) {
        result += "<tr>";
          for(var j=0; j<dataArray.data[i].length; j++){
            result += "<td>"+dataArray.data[i][j]+"</td>";
      }
          result += "<td><button type=\"button\" id=\"buttonModalFinance"+ i +"\"  class=\"btn btn-sm btn-light btnbtn\" data-bs-toggle=\"modal\" data-bs-target=\"#exampleModal\" \" />Edit</button></td>";
          result += "</tr>";
      }
      result += "</table>";
      var div = document.getElementById('dataTableArriwalWaste');
      div.innerHTML = result;
      $('.btnbtn').click(function (i){
        
        //id кнопки
        const idButtonModalFinance = i.currentTarget.attributes.id.value 
        
        //номер рядка из id кнопки (номер редактируемого рядка)
        const row = parseInt(idButtonModalFinance.match(/\d+/))
         
        const allModal = dataArray.data[row] 
        const dateModal = formatDateYYYYtireMMtireDD(strongToDate(allModal[0])) //формат даты
        const summaModal = parseInt(allModal[1].replace(/\s+/g, '')).toFixed(2) // удаляем пробел (.replace(/\s+/g, ''))
        const formaModal = allModal[2]
        const firmaModal = allModal[3]
        const wasteModal = allModal[4]
        $('#exampleModal').on('shown.bs.modal', () => {
          $('#dateModal').val(dateModal)
          $('#summaModal').val(summaModal)
          $('#formaModal').val(formaModal)
          $('#firmaArrivalWasteModal').val(firmaModal)
          $('#wasteModal').val(wasteModal)
          $('#awModalLabel').text(dataArray.length+row-15)
        }) 
      }) 
 
  }else{
    var div = document.getElementById('dataTableArriwalWaste');
    div.innerHTML = "Data not found!";
  }
} */
  function createTableArriwalWaste(dataArray) {
    if (!dataArray.data) return false;
    const nameTable = dataArray.data.slice();
    if (dataArray) {
      var result =
        "<table class='table table-bordered table-hover table-line-selection' style='table-layout: auto;'>";

      // строим таблицу
      for (var i = dataArray.data.length - 2; i > 0; i--) {
        result += "<tr>";
        for (var j = 0; j < dataArray.data[i].length; j++) {
          result += "<td>" + dataArray.data[i][j] + "</td>";
        }
        result +=
          '<td><button type="button" id="buttonModalFinance' +
          i +
          '" class="btn btn-sm btn-light btnbtn" data-bs-toggle="modal" data-bs-target="#exampleModal" " />Edit</button></td>';
        result += "</tr>";
      }
      result += "</table>";
      var div = document.getElementById("dataTableArriwalWaste");
      div.innerHTML = result;
      document.querySelector(".arw-table").style.height = "87vh";
      tableLineSelection(); // полосы в таблице
      $(".btnbtn").click(function (i) {
        //id кнопки
        const idButtonModalFinance = i.currentTarget.attributes.id.value;

        //номер рядка из id кнопки (номер редактируемого рядка)
        const row = parseInt(idButtonModalFinance.match(/\d+/));
        const allModal = dataArray.data[row];
        const dateModal = formatDateYYYYtireMMtireDD(strongToDate(allModal[0])); //формат даты
        const summaModal = strongToNumber(allModal[1]); //строку в число
        const formaModal = allModal[2];
        const firmaModal = allModal[3];
        const wasteModal = allModal[4];
        fromTemplateArw('#modal-body-arw');

        ///////////////////////////////////////////////////////////////////
        document.querySelector("#exampleModal").addEventListener('shown.bs.modal', () => {
          document.querySelector("#exampleModal .date-aw").value = dateModal;
          document.querySelector("#exampleModal .summa-aw").value = summaModal;
          document.querySelector("#exampleModal .forma-aw").value = formaModal;
          document.querySelector("#exampleModal .firmaArrivalWaste-aw").value = firmaModal;
          document.querySelector("#exampleModal .waste-aw").value = wasteModal;
          document.querySelector("#awModalLabel").innerText = row + 2;
        });

      });
    } else {
      var div = document.getElementById("dataTableArriwalWaste");
      div.innerHTML = "Data not found!";
    }
    autoSearchOnOpen(".input-search"); // автопоиск при открытии
  }

  function updateR() {
    document
      .getElementById("buttonModal")
      .addEventListener("click", function () { });
  }

  /////////////////////////////////////////////////
  //Терминал-карантин
  function rowDataTermKar() {
    const date = document.querySelector(".date-aw");
    const summa = document.querySelector(".summa-aw");
    const forma = document.querySelector(".forma-aw");
    const waste = document.querySelector(".waste-aw");
    const termkar = document.querySelector(".termkar-aw");
    const sftermkar = document.querySelector(".sftermkar-aw");

    return (rowData = [
      date.value,
      summa.value * 1,
      forma.value,
      waste.value,
      termkar.value,
      sftermkar.value,
    ]);
  }
  ////////////////////////////////////////////

  //кнопка удаления в модальном окне
  $("#btnDeleteModalAW").on("click", () => {
    if (!window.confirm("Удалить запись?")) {
      return;
    }
    const id = $("#awModalLabel").text();
    if ($("#vrabotevseArriwalWaste").text() === "Прочие поступления") {
      google.script.run
        .withSuccessHandler(() => {
          startDataArriwal();
        })
        .deleteRowArriwalModal(id);
    } else {
      google.script.run
        .withSuccessHandler(() => {
          startDataWaste();
        })
        .deleteRowWasteModal(id);
    }
  });

  //кнопка сохранения в модальном окне
  $("#btnSaveModalAW").on("click", btnSaveModalAW);
  function btnSaveModalAW() {
    $("#exampleModal").modal("hide");
        /* const id = $("#awModalLabel").text();
    const data = [
      [
        $("#exampleModal .date-aw").val(),
        $("#exampleModal .summa-aw").val() * 1,
        $("#exampleModal .forma-aw").val(),
        $("#exampleModal .firmaArrivalWaste-aw").val(),
        $("#exampleModal .waste-aw").val(),
      ],
    ];

    $("exampleModal").modal("hide");
    if ($("#vrabotevseArriwalWaste").text() === "Прочие поступления") {
      google.script.run
        .withSuccessHandler(() => {
          startDataArriwal();
        })
        .changesRowArriwalModal(id, data);
    } else {
      google.script.run
        .withSuccessHandler(() => {
          startDataWaste();
        })
        .changesRowWasteModal(id, data);
    } */
  }

  // подключаем шаблон
  function fromTemplateArw(idInsert) {
    const temp = document.querySelector('#arriwalwaste_forma');
    const clon = temp.content.cloneNode(true);
    const result = document.querySelector(idInsert);
    if (!result.firstChild) {
      result.appendChild(clon);
    }
  }
</script>