<script>

// Ініціалізація форми
const aWForm = new AWFormBuilder('aw', '#AwMainForma', '.container [data-form-fin-main]');
aWForm.render();

// Відображення спінера
function spinner(containerId, show = true) {
  const container = document.getElementById(containerId);
  if (!container) return;
  if (show) {
    container.innerHTML = `
      <div class="d-flex justify-content-center">
        <div class="spinner-border text-danger mb-4 mt-2" role="status">
          <span class="visually-hidden"></span>
        </div>
        Іде пошук...
      </div>`;
  } else if (!container.querySelector('#table-aw')) {
    container.innerHTML = '';
  }
}

// Обробка натискання Enter для збереження
function clickPressAW(event) {
  if (event.keyCode == 13) {
    btnSaveModalAW();
  }
}

// Обробка натискання Enter для витрат
function clickPressAwPrivat(event) {
  if (event.keyCode == 13) {
    buttonClickWaste();
  }
}

// Флаг для запобігання повторного запуску
let isStartArrivalWasteRunning = false;

// Очищення списків вибору
function startArrivalWasteClear() {
  const firmaList = document.querySelector('#firmaArrivalWaste-datalist');
  const wasteList = document.querySelector('#waste-datalist');
  if (firmaList) firmaList.innerHTML = '';
  if (wasteList) wasteList.innerHTML = '';
}

// Отримання унікальних статей надходжень/витрат
function getDropDownArrayStatyaArrivalWaste() {
  const storageDataArrival = localStorage.getItem('dataArrival');
  const storageDataWaste = localStorage.getItem('dataWaste');
  if (!storageDataArrival || !storageDataWaste) return [];
  const dohod = JSON.parse(storageDataArrival).data?.map(x => [x[4]]) || [];
  const rashod = JSON.parse(storageDataWaste).data?.map(x => [x[3]]) || [];
  const dohodRashod = [...new Set(rashod.concat(dohod).filter(String).flat())];
  const stopAw = JSON.parse(localStorage.getItem('stopAw')) || [];
  return searchingSubstringInArrayStrings(dohodRashod, stopAw, 0) || [];
}

// Заповнення списку вибору
function afterDropDownReturned(data, datalistId) {
  const datalist = document.getElementById(datalistId);
  if (datalist) {
    datalist.innerHTML = data ? data.map(item => `<option value="${item}"></option>`).join('') : '';
  }
}

// Отримання унікальних значень із localStorage
function getDropDownArrayOnline(key, index) {
  const data = JSON.parse(localStorage.getItem(key))?.data?.map(x => x[index]) || [];
  return [...new Set(data.filter(String))];
}

// Ініціалізація списків вибору
function startArrivalWaste() {
  if (isStartArrivalWasteRunning) return;
  isStartArrivalWasteRunning = true;
  startArrivalWasteClear();
  afterDropDownReturned(getDropDownArrayOnline('dataArrival', 3), 'firmaArrivalWaste-datalist');
  afterDropDownReturned(getDropDownArrayStatyaArrivalWaste(), 'waste-datalist');
  isStartArrivalWasteRunning = false;
}

// Ініціалізація поля витрат
const costPrivatInput = document.querySelector('#costPrivat');
if (costPrivatInput) {
  costPrivatInput.value = +localStorage.getItem('costPrivat') || '';
}

// Генерація HTML таблиці
function buildTableAw(dataArray) {
  if (!dataArray || !Array.isArray(dataArray) || !dataArray.length) {
    return '<p>Немає даних для відображення</p>';
  }
  let result = `<table class='table table-bordered table-hover table-line-selection' id='table-aw' style='table-layout: auto; width: 100%; border: 1px solid #dee2e6;'>`;
  if (dataArray[0]) {
    const numId = dataArray[0].length - 1;
    for (let i = dataArray.length - 1; i >= 0; i--) {
      result += '<tr>';
      for (let j = 0; j < dataArray[i].length; j++) {
        if (j === numId) continue;
        result += `<td style="padding: 8px;">${dataArray[i][j] || ''}</td>`;
      }
      result += `<td style="padding: 8px;"><button type="button" id="buttonModalFinance${dataArray[i][numId]}" class="btn btn-sm btn-light btnbtn" data-bs-toggle="modal" data-bs-target="#exampleModal">Edit</button></td>`;
      result += '</tr>';
    }
    result += '</table>';
  } else {
    result = '<p>Немає даних для відображення</p>';
  }
  return result;
}

// Відкриття модального вікна
function btnOpenModal(arr, id) {
  // Перевірка параметрів
  if (!arr || !Array.isArray(arr) || !id || typeof id !== 'string') return;

  // Витягнення ID рядка
  const rowIdMatch = id.match(/\d+/);
  if (!rowIdMatch) return;
  const rowId = Number(rowIdMatch[0]);

  // Пошук даних рядка
  const rowData = arr.find(el => Number(el[el.length - 1]) === rowId);
  if (!rowData) return;

  // Перевірка залежних функцій
  if (!window.formatDateYYYYtireMMtireDD || !window.strongToDate || !window.strongToNumber) return;

  // Форматування значень
  let dateModal = '';
  let summaModal = '';
  let formaModal = rowData[2] || '';
  let firmaModal = '';
  let wasteModal = '';
  let termkarModal = '';
  let sftermkarModal = '';
  try {
    dateModal = formatDateYYYYtireMMtireDD(strongToDate(rowData[0]));
  } catch (e) {}
  try {
    summaModal = strongToNumber(rowData[1]);
  } catch (e) {}

  // Визначення полів залежно від довжини масиву
  if (rowData.length === 6) {
    firmaModal = rowData[3] || '';
    wasteModal = rowData[4] || '';
    termkarModal = rowData[5] || '';
  } else if (rowData.length >= 7) {
    firmaModal = rowData[3] || '';
    wasteModal = rowData[4] || '';
    termkarModal = rowData[5] || '';
    sftermkarModal = rowData[6] || '';
  } else {
    wasteModal = rowData[3] || '';
    termkarModal = rowData[4] || '';
    sftermkarModal = rowData[5] || '';
  }

  // Заповнення полів модального вікна
  const fields = [
    { id: '#dateModal', value: dateModal },
    { id: '#summaModal', value: summaModal },
    { id: '#formaModal', value: formaModal },
    { id: '#firmaArrivalWasteModal', value: firmaModal },
    { id: '#wasteModal', value: wasteModal },
    { id: '#termkarModal', value: termkarModal },
    { id: '#sftermkarModal', value: sftermkarModal },
    { id: '#awModalLabel', value: rowId + 2, isText: true },
  ];
  fields.forEach(field => {
    const element = $(field.id);
    if (!element.length) return;
    if (field.isText) {
      element.text(field.value);
    } else {
      element.val(field.value);
    }
  });
}

// Рендеринг таблиці
function createTableArriwalWaste(dataArray) {
  // Перевірка контейнера
  const tableContainer = document.getElementById('dataTableArriwalWaste');
  if (!tableContainer) return;

  // Перевірка даних
  if (!dataArray || !dataArray.data || !Array.isArray(dataArray.data)) {
    alert('Дані відсутні або некоректні');
    tableContainer.innerHTML = '<p>Немає даних для відображення</p>';
    return;
  }

  // Перевірка поля пошуку
  const searchInput = document.querySelector('#search');
  if (!searchInput) return;

  // Перевірка заголовка
  const header = document.querySelector('#vrabotevseArriwalWaste');
  if (!header) return;

  // Рендеринг таблиці
  function renderTable(data) {
    try {
      tableContainer.innerHTML = buildTableAw(data);
      const buttons = document.querySelectorAll('.btnbtn');
      buttons.forEach(button => {
        button.removeEventListener('click', handleEditClick);
        button.addEventListener('click', handleEditClick);
        function handleEditClick() {
          const id = button.id;
          const modal = $('#exampleModal');
          if (!modal.length) return;
          modal.modal('show');
          modal.one('shown.bs.modal', () => {
            btnOpenModal(data, id);
          });
        }
      });
      if (typeof clickTables === 'function') {
        clickTables('#table-aw', () => {
          if (event.target.tagName !== 'TD') return;
          searchInput.value = event.target.textContent;
          renderTable(dataArray.data);
        });
      }
    } catch (e) {
      tableContainer.innerHTML = '<p>Помилка відображення даних</p>';
    }
  }

  // Обробка пошуку
  function handleSearch() {
    const query = searchInput.value.trim();
    if (!header.textContent) return;
    let dataToRender = dataArray.data;
    if (query && typeof findInTable === 'function') {
      dataToRender = findInTable(dataArray.data, query);
    }
    renderTable(dataToRender);
  }

  // Ініціалізація таблиці
  renderTable(dataArray.data);

  // Налаштування обробників пошуку
  searchInput.removeEventListener('input', handleSearch);
  searchInput.removeEventListener('click', handleSearch);
  searchInput.removeEventListener('keyup', handleSearch);
  searchInput.addEventListener('input', handleSearch);
  searchInput.addEventListener('click', handleSearch);
  searchInput.addEventListener('keyup', handleSearch);

  // Автопошук
  if (typeof autoSearchOnOpen === 'function') {
    autoSearchOnOpen('.input-search');
  }

  // Оновлення localStorage
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(data => {
        localStorage.setItem('dataWaste', JSON.stringify(data));
        const wasteTabButton = document.querySelector('#buttonWasteTab');
        if (wasteTabButton) wasteTabButton.disabled = false;
      })
      .withFailureHandler(error => {
        alert('Помилка отримання даних витрат: ' + error);
      })
      .getLastTenRowsWaste();
    google.script.run
      .withSuccessHandler(data => {
        localStorage.setItem('dataCashe', JSON.stringify(data));
      })
      .withFailureHandler(error => {
        alert('Помилка отримання даних кешу: ' + error);
      })
      .getDropDownArrayCashe();
  }
}

// Оновлення кнопки модального вікна
function updateR() {
  const buttonModal = document.getElementById('buttonModal');
  if (buttonModal) {
    buttonModal.addEventListener('click', () => {});
  }
}

// Отримання даних із полів
function rowDataTermKar() {
  const fields = ['date', 'summa', 'forma', 'waste', 'termkar', 'sftermkar'];
  return fields.map(id => {
    const element = document.getElementById(id);
    return element ? (id === 'summa' ? +element.value : element.value) : '';
  });
}

// Видалення запису
$('#btnDeleteModalAW').on('click', () => {
  if (!window.confirm('Удалить запись?')) return;
  const id = $('#awModalLabel').text();
  spinner('dataTableArriwalWaste', true);
  if ($('#vrabotevseArriwalWaste').text() === 'Інші надходження') {
    google.script.run
      .withSuccessHandler(() => {
        spinner('dataTableArriwalWaste', false);
        startDataArriwal();
      })
      .withFailureHandler(error => {
        spinner('dataTableArriwalWaste', false);
        alert('Помилка видалення: ' + error);
      })
      .deleteRowArriwalModal(id);
  } else if ($('#vrabotevseArriwalWaste').text() === 'Інші витрати') {
    google.script.run
      .withSuccessHandler(() => {
        spinner('dataTableArriwalWaste', false);
        startDataWaste();
      })
      .withFailureHandler(error => {
        spinner('dataTableArriwalWaste', false);
        alert('Помилка видалення: ' + error);
      })
      .deleteRowWasteModal(id);
  } else {
    spinner('dataTableArriwalWaste', false);
    alert('Перевір function btnSaveModalAW()');
  }
});

// Збереження даних із модального вікна
$('#btnSaveModalAW').on('click', btnSaveModalAW);
function btnSaveModalAW() {
  const id = $('#awModalLabel').text();
  const data = [[
    $('#dateModal').val(),
    $('#summaModal').val() * 1,
    $('#formaModal').val(),
    $('#firmaArrivalWasteModal').val(),
    $('#wasteModal').val(),
    $('#termkarModal').val(),
    $('#sftermkarModal').val(),
  ]];
  $('#exampleModal').modal('hide');
  spinner('dataTableArriwalWaste', true);
  if ($('#vrabotevseArriwalWaste').text() === 'Інші надходження') {
    google.script.run
      .withSuccessHandler(() => {
        google.script.run
          .withSuccessHandler(data => {
            spinner('dataTableArriwalWaste', false);
            localStorage.setItem('dataArrival', JSON.stringify(data));
            createTableArriwalWaste(data);
          })
          .withFailureHandler(error => {
            spinner('dataTableArriwalWaste', false);
            alert('Помилка отримання даних: ' + error);
          })
          .getLastTenRowsArriwal();
      })
      .withFailureHandler(error => {
        spinner('dataTableArriwalWaste', false);
        alert('Помилка збереження: ' + error);
      })
      .changesRowArriwalModal(id, data);
  } else if ($('#vrabotevseArriwalWaste').text() === 'Інші витрати') {
    google.script.run
      .withSuccessHandler(() => {
        google.script.run
          .withSuccessHandler(data => {
            spinner('dataTableArriwalWaste', false);
            localStorage.setItem('dataWaste', JSON.stringify(data));
            createTableArriwalWaste(data);
          })
          .withFailureHandler(error => {
            spinner('dataTableArriwalWaste', false);
            alert('Помилка отримання даних: ' + error);
          })
          .getLastTenRowsWaste();
      })
      .withFailureHandler(error => {
        spinner('dataTableArriwalWaste', false);
        alert('Помилка збереження: ' + error);
      })
      .changesRowWasteModal(id, data);
  } else {
    spinner('dataTableArriwalWaste', false);
    alert('Перевір function btnSaveModalAW()');
  }
}

// Спостереження за змінами в таблиці
function mutationObserverAw() {
  let observer = new MutationObserver(mutations => {
    mutations.forEach(() => {
      const search = document.querySelector('#search');
      const summa = document.querySelector('#vrabotevse-arriwalwaste-summa');
      if (
        !search?.value ||
        !document.getElementById('dataTableArriwalWaste').hasChildNodes() ||
        summa?.innerHTML === 'Разом: 0.00 грн'
      ) {
        if (summa) summa.innerHTML = '';
      }
    });
  });
  const tableContainer = document.getElementById('dataTableArriwalWaste');
  if (tableContainer) {
    observer.observe(tableContainer, { attributes: true, childList: true, subtree: true });
  }
}
mutationObserverAw();

// Колір фону для поля витрат
function costPrivatColor() {
  const costpriv = document.querySelector('#costPrivat');
  const costPrivatLabel = document.querySelector('label[for="costPrivat"]');
  const updateBackgroundColor = () => {
    if (costpriv) {
      if (!+costpriv.value) {
        costpriv.style.backgroundColor = '#dc35457a';
      } else {
        costpriv.style.removeProperty('background-color');
      }
    }
  };
  updateBackgroundColor();
  if (costpriv) costpriv.addEventListener('input', updateBackgroundColor);
  if (costPrivatLabel) costPrivatLabel.addEventListener('click', updateBackgroundColor);
}
costPrivatColor();

// Завантаження даних витрат
function startDataWaste() {
  spinner('dataTableArriwalWaste', true);
  google.script.run
    .withSuccessHandler(data => {
      localStorage.setItem('dataWaste', JSON.stringify(data));
      createTableArriwalWaste(data);
      spinner('dataTableArriwalWaste', false);
    })
    .withFailureHandler(error => {
      spinner('dataTableArriwalWaste', false);
      alert('Помилка отримання даних витрат: ' + error);
    })
    .getLastTenRowsWaste();
}

// Завантаження даних надходжень
function startDataArriwal() {
  spinner('dataTableArriwalWaste', true);
  google.script.run
    .withSuccessHandler(data => {
      localStorage.setItem('dataArrival', JSON.stringify(data));
      createTableArriwalWaste(data);
      spinner('dataTableArriwalWaste', false);
    })
    .withFailureHandler(error => {
      spinner('dataTableArriwalWaste', false);
      alert('Помилка отримання даних надходжень: ' + error);
    })
    .getLastTenRowsArriwal();
}

// Ініціалізація сторінки
$(document).ready(function () {
  // Очищення модального вікна
  $('#exampleModal').on('shown.bs.modal', function () {
    $('#dateModal').val('');
    $('#summaModal').val('');
    $('#formaModal').val('');
    $('#firmaArrivalWasteModal').val('');
    $('#wasteModal').val('');
    $('#termkarModal').val('');
    $('#sftermkarModal').val('');
    $('#awModalLabel').text('');
  });

  // Обробка кліків по вкладках
  const buttonWasteTab = document.querySelector('#buttonWasteTab');
  const buttonArrivalTab = document.querySelector('#buttonArrivalTab');
  if (buttonWasteTab) {
    buttonWasteTab.removeEventListener('click', handleWasteTabClick);
    buttonWasteTab.addEventListener('click', handleWasteTabClick);
  }
  if (buttonArrivalTab) {
    buttonArrivalTab.removeEventListener('click', handleArrivalTabClick);
    buttonArrivalTab.addEventListener('click', handleArrivalTabClick);
  }

  // Обробка вкладки витрат
  function handleWasteTabClick() {
    const header = document.querySelector('#vrabotevseArriwalWaste');
    const tableDiv = document.querySelector('#divDataTableArriwalWaste');
    const tableContainer = document.querySelector('#dataTableArriwalWaste');
    if (!header || !tableDiv || !tableContainer) return;
    const dataWaste = JSON.parse(localStorage.getItem('dataWaste'));
    if (!dataWaste || !dataWaste.data || !dataWaste.data.length) {
      header.innerHTML = 'Інші витрати';
      tableContainer.innerHTML = '<p>Немає даних для відображення</p>';
      return;
    }
    header.innerHTML = 'Інші витрати';
    tableDiv.style.height = 'auto';
    tableDiv.style.display = 'block';
    tableDiv.style.visibility = 'visible';
    tableContainer.style.display = 'block';
    spinner('dataTableArriwalWaste', true);
    if (!tableContainer.querySelector('#table-aw')) {
      createTableArriwalWaste(dataWaste);
    }
    spinner('dataTableArriwalWaste', false);
  }

  // Обробка вкладки надходжень
  function handleArrivalTabClick() {
    const header = document.querySelector('#vrabotevseArriwalWaste');
    const tableDiv = document.querySelector('#divDataTableArriwalWaste');
    const tableContainer = document.querySelector('#dataTableArriwalWaste');
    if (!header || !tableDiv || !tableContainer) return;
    const dataArrival = JSON.parse(localStorage.getItem('dataArrival'));
    if (!dataArrival || !dataArrival.data || !dataArrival.data.length) {
      header.innerHTML = 'Інші надходження';
      tableContainer.innerHTML = '<p>Немає даних для відображення</p>';
      return;
    }
    header.innerHTML = 'Інші надходження';
    tableDiv.style.height = 'auto';
    tableDiv.style.display = 'block';
    tableDiv.style.visibility = 'visible';
    tableContainer.style.display = 'block';
    spinner('dataTableArriwalWaste', true);
    if (!tableContainer.querySelector('#table-aw')) {
      createTableArriwalWaste(dataArrival);
    }
    spinner('dataTableArriwalWaste', false);
  }
});

</script>