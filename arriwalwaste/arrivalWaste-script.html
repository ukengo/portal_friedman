<script>

const aWForm = new AWFormBuilder('aw', '#AwMainForma', '.container [data-form-fin-main]');
aWForm.render();

function spinner(containerId, show = true) {
  const container = document.getElementById(containerId);
  if (!container) return;
  if (show) {
    container.innerHTML = `
      <div class="d-flex justify-content-center">
        <div class="spinner-border text-danger mb-4 mt-2" role="status">
          <span class="visually-hidden"></span>
        </div>
        Іде пошук...
      </div>`;
  } else if (!container.querySelector('#table-aw')) {
    container.innerHTML = '';
  }
}

function clickPressAW(event) {
  if (event.keyCode == 13) {
    btnSaveModalAW();
  }
}

function clickPressAwPrivat(event) {
  if (event.keyCode == 13) {
    buttonClickWaste();
  }
}

let isStartArrivalWasteRunning = false;

function startArrivalWasteClear() {
  const firmaList = document.querySelector('#firmaArrivalWaste-datalist');
  const wasteList = document.querySelector('#waste-datalist');
  if (firmaList) firmaList.innerHTML = '';
  if (wasteList) wasteList.innerHTML = '';
}

function getDropDownArrayStatyaArrivalWaste() {
  const storageDataArrival = localStorage.getItem('dataArrival');
  const storageDataWaste = localStorage.getItem('dataWaste');
  if (!storageDataArrival || !storageDataWaste) return [];
  const dohod = JSON.parse(storageDataArrival).data.map((x) => [x[4]]);
  const rashod = JSON.parse(storageDataWaste).data.map((x) => [x[3]]);
  const dohodRashod = [...new Set(rashod.concat(dohod).filter(String).flat())];
  const stopAw = JSON.parse(localStorage.getItem('stopAw')) || [];
  return searchingSubstringInArrayStrings(dohodRashod, stopAw, 0) || [];
}

function afterDropDownReturned(data, datalistId) {
  const datalist = document.getElementById(datalistId);
  if (datalist) {
    datalist.innerHTML = data ? data.map(item => `<option value="${item}"></option>`).join('') : '';
  }
}

function getDropDownArrayOnline(key, index) {
  const data = JSON.parse(localStorage.getItem(key))?.data?.map(x => x[index]) || [];
  return [...new Set(data.filter(String))];
}

function startArrivalWaste() {
  if (isStartArrivalWasteRunning) return;
  isStartArrivalWasteRunning = true;
  startArrivalWasteClear();
  afterDropDownReturned(getDropDownArrayOnline('dataArrival', 3), 'firmaArrivalWaste-datalist');
  afterDropDownReturned(getDropDownArrayStatyaArrivalWaste(), 'waste-datalist');
  isStartArrivalWasteRunning = false;
}

const costPrivatInput = document.querySelector('#costPrivat');
if (costPrivatInput) {
  costPrivatInput.value = +localStorage.getItem('costPrivat') || '';
}

const buildTableAw = (dataArray) => {
  if (!dataArray || !dataArray.length) {
    return '<p>Немає даних для відображення</p>';
  }
  let result = `<table class='table table-bordered table-hover table-line-selection' id='table-aw' style='table-layout: auto; width: 100%; border: 1px solid #dee2e6;'>`;
  const dataArrayData = dataArray;

  if (dataArrayData.length > 0 && dataArrayData[0]) {
    const numId = +dataArrayData[0].length - 1;
    for (let i = dataArrayData.length - 1; i >= 0; i--) {
      result += '<tr>';
      for (let j = 0; j < dataArrayData[i].length; j++) {
        if (j === numId) continue;
        result += `<td style="padding: 8px;">${dataArrayData[i][j] || ''}</td>`;
      }
      result += `<td style="padding: 8px;"><button type="button" id="buttonModalFinance${dataArrayData[i][numId]}" class="btn btn-sm btn-light btnbtn" data-bs-toggle="modal" data-bs-target="#exampleModal">Edit</button></td>`;
      result += '</tr>';
    }
    result += '</table>';
  } else {
    result = '<p>Немає даних для відображення</p>';
  }
  return result;
};

function btnOpenModal(arr, id) {
  const rowId = Number(id.match(/\d+/));
  const rowData = arr.find((el) => Number(el[el.length - 1]) === rowId);
  
  if (!rowData) return;

  const dateModal = formatDateYYYYtireMMtireDD(strongToDate(rowData[0]));
  const summaModal = strongToNumber(rowData[1]);
  const formaModal = rowData[2] || '';
  const firmaModal = rowData.length === 6 ? rowData[3] || '' : '';
  const wasteModal = rowData.length === 6 ? rowData[4] || '' : rowData[3] || '';
  const termkarModal = rowData.length === 6 ? rowData[5] || '' : rowData[4] || '';
  const sftermkarModal = rowData.length === 6 ? rowData[6] || '' : rowData[5] || '';

  $('#dateModal').val(dateModal);
  $('#summaModal').val(summaModal);
  $('#formaModal').val(formaModal);
  $('#firmaArrivalWasteModal').val(firmaModal);
  $('#wasteModal').val(wasteModal);
  $('#termkarModal').val(termkarModal);
  $('#sftermkarModal').val(sftermkarModal);
  $('#awModalLabel').text(rowId + 2);
}

function createTableArriwalWaste(dataArray) {
  const div = document.getElementById('dataTableArriwalWaste');
  if (!div) return;
  div.style.display = 'block';
  div.style.visibility = 'visible';
  spinner('dataTableArriwalWaste', false);
  if (!dataArray || !dataArray.data || !dataArray.data.length) {
    div.innerHTML = '<p>Немає даних для відображення</p>';
    return;
  }

  if (!div.querySelector('#table-aw')) {
    div.innerHTML = buildTableAw(dataArray.data);
  }

  const searchInput = document.querySelector('#search');
  function searchValueAw() {
    const headerText = $('#vrabotevseArriwalWaste').text();
    if (!headerText) return;
    const dataSearchValue = searchInput?.value || '';
    const tableExists = div.querySelector('#table-aw');
    if (!tableExists) return;
    if (dataSearchValue) {
      const dataSearchResult = findInTable(dataArray.data, dataSearchValue);
      div.innerHTML = buildTableAw(dataSearchResult);
      $('.btnbtn').off('click').on('click', function () {
        btnOpenModal(dataSearchResult, this.id);
      });
    } else {
      div.innerHTML = buildTableAw(dataArray.data);
      $('.btnbtn').off('click').on('click', function () {
        btnOpenModal(dataArray.data, this.id);
      });
    }
  }

  if (searchInput) {
    searchInput.removeEventListener('click', searchValueAw);
    searchInput.removeEventListener('keyup', searchValueAw);
    searchInput.removeEventListener('input', searchValueAw);
    searchInput.addEventListener('input', debounce(searchValueAw, 300));
  }

  clickTables('#table-aw', () => {
    if (event.target.tagName !== 'TD') return false;
    const dataTarget = event.target.textContent;
    if (searchInput) searchInput.value = dataTarget;
    searchValueAw();
  });
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function updateR() {
  const buttonModal = document.getElementById('buttonModal');
  if (buttonModal) {
    buttonModal.addEventListener('click', () => {});
  }
}

function rowDataTermKar() {
  const fields = ['date', 'summa', 'forma', 'waste', 'termkar', 'sftermkar'];
  return fields.map((id) => {
    const element = document.getElementById(id);
    return element ? (id === 'summa' ? +element.value : element.value) : '';
  });
}

$('#btnDeleteModalAW').on('click', () => {
  if (!window.confirm('Удалить запись?')) return;
  const id = $('#awModalLabel').text();
  spinner('dataTableArriwalWaste', true);
  if ($('#vrabotevseArriwalWaste').text() === 'Інші надходження') {
    google.script.run
      .withSuccessHandler(() => {
        spinner('dataTableArriwalWaste', false);
        startDataArriwal();
      })
      .withFailureHandler((error) => {
        spinner('dataTableArriwalWaste', false);
        alert('Помилка видалення: ' + error);
      })
      .deleteRowArriwalModal(id);
  } else if ($('#vrabotevseArriwalWaste').text() === 'Інші витрати') {
    google.script.run
      .withSuccessHandler(() => {
        spinner('dataTableArriwalWaste', false);
        startDataWaste();
      })
      .withFailureHandler((error) => {
        spinner('dataTableArriwalWaste', false);
        alert('Помилка видалення: ' + error);
      })
      .deleteRowWasteModal(id);
  } else {
    spinner('dataTableArriwalWaste', false);
    alert('Перевір function btnSaveModalAW()');
  }
});

$('#btnSaveModalAW').on('click', btnSaveModalAW);
function btnSaveModalAW() {
  const id = $('#awModalLabel').text();
  const data = [
    [
      $('#dateModal').val(),
      $('#summaModal').val() * 1,
      $('#formaModal').val(),
      $('#firmaArrivalWasteModal').val(),
      $('#wasteModal').val(),
      $('#termkarModal').val(),
      $('#sftermkarModal').val(),
    ],
  ];

  $('#exampleModal').modal('hide');
  spinner('dataTableArriwalWaste', true);
  if ($('#vrabotevseArriwalWaste').text() === 'Інші надходження') {
    google.script.run
      .withSuccessHandler(() => {
        google.script.run
          .withSuccessHandler((data) => {
            spinner('dataTableArriwalWaste', false);
            localStorage.setItem('dataArrival', JSON.stringify(data));
            createTableArriwalWaste(data);
          })
          .withFailureHandler((error) => {
            spinner('dataTableArriwalWaste', false);
            alert('Помилка отримання даних: ' + error);
          })
          .getLastTenRowsArriwal();
      })
      .withFailureHandler((error) => {
        spinner('dataTableArriwalWaste', false);
        alert('Помилка збереження: ' + error);
      })
      .changesRowArriwalModal(id, data);
  } else if ($('#vrabotevseArriwalWaste').text() === 'Інші витрати') {
    google.script.run
      .withSuccessHandler(() => {
        google.script.run
          .withSuccessHandler((data) => {
            spinner('dataTableArriwalWaste', false);
            localStorage.setItem('dataWaste', JSON.stringify(data));
            createTableArriwalWaste(data);
          })
          .withFailureHandler((error) => {
            spinner('dataTableArriwalWaste', false);
            alert('Помилка отримання даних: ' + error);
          })
          .getLastTenRowsWaste();
      })
      .withFailureHandler((error) => {
        spinner('dataTableArriwalWaste', false);
        alert('Помилка збереження: ' + error);
      })
      .changesRowWasteModal(id, data);
  } else {
    spinner('dataTableArriwalWaste', false);
    alert('Перевір function btnSaveModalAW()');
  }
}

const mutationObserverAw = () => {
  let observer = new MutationObserver((mutations) => {
    mutations.forEach(() => {
      const search = document.querySelector('#search');
      const summa = document.querySelector('#vrabotevse-arriwalwaste-summa');
      if (
        !search?.value ||
        !document.getElementById('dataTableArriwalWaste').hasChildNodes() ||
        summa?.innerHTML === 'Разом: 0.00 грн'
      ) {
        if (summa) summa.innerHTML = '';
      }
    });
  });
  const tableContainer = document.getElementById('dataTableArriwalWaste');
  if (tableContainer) {
    observer.observe(tableContainer, {
      attributes: true,
      childList: true,
      subtree: true,
    });
  }
};
mutationObserverAw();

const costPrivatColor = () => {
  const costpriv = document.querySelector('#costPrivat');
  const costPrivatLabel = document.querySelector('label[for="costPrivat"]');

  // Функція для перевірки та розфарбовки
  const updateBackgroundColor = () => {
    console.log(costpriv.value);
    if (costpriv) {
      if (!+costpriv.value) {
        costpriv.style.backgroundColor = '#dc35457a';
      } else {
        costpriv.style.removeProperty('background-color');
      }
    }
  };

  // Виклик функції для початкової перевірки
  updateBackgroundColor();

  // Додавання обробника події для input
  if (costpriv) {
    costpriv.addEventListener('input', updateBackgroundColor);
  }

  // Додавання обробника події для кліку на label
  if (costPrivatLabel) {
    costPrivatLabel.addEventListener('click', updateBackgroundColor);
  }
};

// Виклик функції
costPrivatColor();

function startDataWaste() {
  spinner('dataTableArriwalWaste', true);
  google.script.run
    .withSuccessHandler((data) => {
      localStorage.setItem('dataWaste', JSON.stringify(data));
      createTableArriwalWaste(data);
      spinner('dataTableArriwalWaste', false);
    })
    .withFailureHandler((error) => {
      spinner('dataTableArriwalWaste', false);
      alert('Помилка отримання даних витрат: ' + error);
    })
    .getLastTenRowsWaste();
}

function startDataArriwal() {
  spinner('dataTableArriwalWaste', true);
  google.script.run
    .withSuccessHandler((data) => {
      localStorage.setItem('dataArrival', JSON.stringify(data));
      createTableArriwalWaste(data);
      spinner('dataTableArriwalWaste', false);
    })
    .withFailureHandler((error) => {
      spinner('dataTableArriwalWaste', false);
      alert('Помилка отримання даних надходжень: ' + error);
    })
    .getLastTenRowsArriwal();
}

$(document).ready(function () {
  $('#exampleModal').on('shown.bs.modal', function () {
    $('#dateModal').val('');
    $('#summaModal').val('');
    $('#formaModal').val('');
    $('#firmaArrivalWasteModal').val('');
    $('#wasteModal').val('');
    $('#termkarModal').val('');
    $('#sftermkarModal').val('');
    $('#awModalLabel').text('');
  });

  const buttonWasteTab = document.querySelector('#buttonWasteTab');
  const buttonArrivalTab = document.querySelector('#buttonArrivalTab');

  if (buttonWasteTab) {
    buttonWasteTab.removeEventListener('click', handleWasteTabClick);
    buttonWasteTab.addEventListener('click', handleWasteTabClick);
  }

  if (buttonArrivalTab) {
    buttonArrivalTab.removeEventListener('click', handleArrivalTabClick);
    buttonArrivalTab.addEventListener('click', handleArrivalTabClick);
  }

  function handleWasteTabClick() {
    const header = document.querySelector('#vrabotevseArriwalWaste');
    const tableDiv = document.querySelector('#divDataTableArriwalWaste');
    const tableContainer = document.querySelector('#dataTableArriwalWaste');
    if (!header || !tableDiv || !tableContainer) return;
    const dataWaste = JSON.parse(localStorage.getItem('dataWaste'));
    if (!dataWaste || !dataWaste.data || !dataWaste.data.length) {
      header.innerHTML = 'Інші витрати';
      tableContainer.innerHTML = '<p>Немає даних для відображення</p>';
      return;
    }
    header.innerHTML = 'Інші витрати';
    tableDiv.style.height = 'auto';
    tableDiv.style.display = 'block';
    tableDiv.style.visibility = 'visible';
    tableContainer.style.display = 'block';
    spinner('dataTableArriwalWaste', true);
    if (!tableContainer.querySelector('#table-aw')) {
      createTableArriwalWaste(dataWaste);
    }
    spinner('dataTableArriwalWaste', false);
    // startArrivalWaste(); // Закоментовано для стабільності
  }

  function handleArrivalTabClick() {
    const header = document.querySelector('#vrabotevseArriwalWaste');
    const tableDiv = document.querySelector('#divDataTableArriwalWaste');
    const tableContainer = document.querySelector('#dataTableArriwalWaste');
    if (!header || !tableDiv || !tableContainer) return;
    const dataArrival = JSON.parse(localStorage.getItem('dataArrival'));
    if (!dataArrival || !dataArrival.data || !dataArrival.data.length) {
      header.innerHTML = 'Інші надходження';
      tableContainer.innerHTML = '<p>Немає даних для відображення</p>';
      return;
    }
    header.innerHTML = 'Інші надходження';
    tableDiv.style.height = 'auto';
    tableDiv.style.display = 'block';
    tableDiv.style.visibility = 'visible';
    tableContainer.style.display = 'block';
    spinner('dataTableArriwalWaste', true);
    if (!tableContainer.querySelector('#table-aw')) {
      createTableArriwalWaste(dataArrival);
    }
    spinner('dataTableArriwalWaste', false);
    // startArrivalWaste(); // Закоментовано для стабільності
  }
});
  
</script>