<script>
  // Стилі для елементів форми
  const customStyles = {
    awBody: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '5px' },
    awButtonsContainer: { gridColumn: 'span 2', alignSelf: 'end', marginBottom: '-7px' },
    wasteField: { gridColumn: 'span 2' }
  };
  
  // Утилітні функції
  const utils = {
    setInputValue: (element, value) => { // Встановлення значення в поле вводу
      if (!element) return;
      element.value = value;
      element.setAttribute('value', value);
      ['input', 'change'].forEach(event => element.dispatchEvent(new Event(event, { bubbles: true })));
    },
    applyStyles: (element, styles) => element && Object.assign(element.style, styles), // Застосування стилів до елемента
    extractProjectNumber: text => text.match(/пр\.?\s*(\d+)/i)?.[1] || null, // Витяг номера проекту
    extractInspectors: data => data ? JSON.parse(data).map(item => item[0].split(' ')[0].toLowerCase()) : [], // Витяг інспекторів
    extractDataFromTd: cells => Array.from(cells).map(cell => cell.textContent), // Витяг даних із комірок
    toggleContainers: (finance, aw, showFinance, showAw) => { // Перемикання видимості контейнерів
      const styleContainer = (container, show) => utils.applyStyles(container, {
        display: show ? 'block' : 'none',
        marginTop: show ? '50px' : '0px',
        paddingTop: show ? '15px' : '0px'
      });
      styleContainer(finance, showFinance);
      styleContainer(aw, showAw);
    },
    clearContainer: container => container && (container.innerHTML = '') // Очищення контейнеру
  };
  
  // Приховування секцій працівників у AW-контейнері
  const hideWorkersInAwContainer = () => {
    const awContainer = document.querySelector('[data-cashe-rom-aw-container]');
    if (awContainer) {
      awContainer.querySelectorAll('section.workers.radius.p-1')
        .forEach(section => utils.applyStyles(section, { display: 'none' }));
    }
    const mainFormContainer = document.querySelector('[data-form-fin-main]');
    if (mainFormContainer) {
      const mainWorkers = mainFormContainer.querySelector('section.workers.radius.p-1');
      if (mainWorkers) {
        utils.applyStyles(mainWorkers, { display: '' });
      }
    }
  };
  
  // Функція запуску побудови таблиці
  function startDataTableCasherom() {
    btnCasheromInsert.disabled = true;
    spinner('tableCaheRom');
    google.script.run.withSuccessHandler(buildDataTableCasherom).getRecordsCasheAll();
  }
  
  // Побудова таблиці
  function buildDataTableCasherom() {
    const [casheRom1, casheRom2] = ['casheRom1', 'casheRom2'].map(key => JSON.parse(localStorage.getItem(key)));
    utils.clearContainer(document.querySelector('#tableCaheRom'));
  
    const table = new DataTable('#tableCaheRom', {
      destroy: true,
      data: casheRom1,
      columns: ["1", "Дата", "Стаття", "Витрата", "Прихід", "Примітки"].map(title => ({ title })),
      lengthMenu: [[50, 100, 500, -1, 0], [50, 100, 500, "Все", "Пусто"]],
      order: [[0, 'desc']],
      select: true
    });
  
    btnCasheromInsert.disabled = false;
    const casheRom2F = casheRom2.filter(el => el[1]);
    if (casheRom2F.length > 1) {
      document.querySelectorAll('#tableCaheRom tbody tr').forEach((el, ind) => {
        if (ind < casheRom2F.length - 1) el.style.color = 'red';
      });
    }
  
    addUpButtonDT(startDataTableCasherom, 'tableCaheRom', 'inputDtCashe');
  }
  
  // Оновлення полів форм
  const formUpdater = {
    finance: () => { // Оновлення фінансової форми
      const els = {
        article: '#casheInputArticle', project: '#proektfin-casherom', prim: '#primfin-casherom',
        ispolu: '#ispolufinance-casherom', waste: '#casheInputWaste', arrival: '#casheInputArrival',
        summa: '#summafin-casherom', date: '#casheInputDate', dateOpl: '#dateoplfin-casherom',
        oznaka: '#priznakfin-casherom'
      };
      const elements = Object.fromEntries(Object.entries(els).map(([k, v]) => [k, document.querySelector(v)]));
      if (Object.values(elements).some(el => !el)) return;
  
      const articleValue = elements.article.value.trim().toLowerCase().replace(/\s+/g, ' ');
      const projectNumber = utils.extractProjectNumber(articleValue);
      if (projectNumber) utils.setInputValue(elements.project, projectNumber);
  
      ['prim', 'summa', 'dateOpl', ...(elements.oznaka ? ['oznaka'] : [])].forEach(k => utils.setInputValue(elements[k], ''));
      elements.ispolu.checked = false;
  
      const inspectors = utils.extractInspectors(localStorage.getItem('dataInspektorZU'));
      const keywordsConfig = {
        'торопова': { value: 'викон Торопова', activateIspolu: true },
        'третьяк': { value: 'викон', activateIspolu: true },
        'токарев': { value: 'викон', activateIspolu: true },
        'шалыга': { value: 'викон', activateIspolu: true },
        'чечеткин': { value: 'викон', activateIspolu: true },
        'косинский': { value: 'викон', activateIspolu: true },
        'корчинская': { value: 'викон', activateIspolu: true },
        'опер': { value: 'викон', activateIspolu: true },
        'досм': { value: 'викон термінал', activateIspolu: false },
        'шелудько': { value: 'викон термінал', activateIspolu: false },
        'грузчики': { value: 'вантажники термінал', activateIspolu: false },
        'болик': { value: 'контр', activateIspolu: false }
      };
  
      for (const [keyword, { value, activateIspolu }] of Object.entries(keywordsConfig)) {
        if (articleValue.includes(keyword)) {
          utils.setInputValue(elements.prim, value);
          elements.ispolu.checked = activateIspolu;
          break;
        }
      }
  
      if (!elements.prim.value && inspectors.length) {
        for (const inspector of inspectors) {
          if (articleValue.includes(inspector)) {
            utils.setInputValue(elements.prim, 'викон');
            elements.ispolu.checked = true;
            break;
          }
        }
      }
  
      if (elements.oznaka) utils.setInputValue(elements.oznaka, 'гот');
      const [wasteValue, arrivalValue] = [elements.waste, elements.arrival].map(el => parseFloat(el.value.trim()));
      if (!isNaN(wasteValue) && wasteValue > 0) utils.setInputValue(elements.summa, wasteValue);
      else if (!isNaN(arrivalValue) && arrivalValue > 0) utils.setInputValue(elements.summa, arrivalValue);
      if (elements.date.value) utils.setInputValue(elements.dateOpl, elements.date.value);
    },
    aw: () => { // Оновлення AW-форми
      const els = {
        waste: '#casheInputWaste', date: '#casheInputDate', summaAw: '#summa-casherom-aw',
        dateAw: '#date-casherom-aw', article: '#casheInputArticle', wasteAw: '#waste-casherom-aw'
      };
      const elements = Object.fromEntries(Object.entries(els).map(([k, v]) => [k, document.querySelector(v)]));
      const phoneConfig = {
        'Зіновкіна бонус': 'Зіновкіна бонус',
        '0674021578': 'Київстар 0674021578',
        '0675042079': 'Київстар 0675042079',
        'zadarma': 'Задарма Zadarma'
      };
  
      if (elements.article && elements.wasteAw) {
        const articleValue = elements.article.value.trim().toLowerCase();
        for (const [key, value] of Object.entries(phoneConfig)) {
          if (articleValue.includes(key.toLowerCase())) {
            utils.setInputValue(elements.wasteAw, value);
            break;
          }
        }
      }
  
      const wasteValue = parseFloat(elements.waste.value.trim());
      if (!isNaN(wasteValue) && wasteValue > 0) utils.setInputValue(elements.summaAw, wasteValue);
      if (elements.date.value) utils.setInputValue(elements.dateAw, elements.date.value);
      return elements;
    }
  };
  
  // Стан форми
  const formState = { isFinanceVisible: false, isAwVisible: false };
  
  // Обробник подій
  document.addEventListener('click', e => {
    const [financeContainer, awContainer] = ['[data-cashe-rom-finance-container]', '[data-cashe-rom-aw-container]']
      .map(sel => document.querySelector(sel));
  
    if (e.target.matches('#tableCaheRom td') && !window.getSelection().toString()) {
      const data = utils.extractDataFromTd(e.target.parentNode.children);
      const dialog = new PopupEditing();
      renderFormsCasheRom('.dialog__header', '.dialog__body', data);
      renderContainerButtonsCasheRom();
      renderButtonsCasheRom();
      renderContainerFinanceCasheRom();
      renderContainerAwCasheRom();
  
      const formaCassheRom = new FormDataFromTables('[data-cashe-rom-forma-container]');
      const articleValue = data[2]?.toLowerCase() || '';
  
      const formActions = {
        showFinance: () => { // Показ фінансової форми
          const financeForm = new FinanceFormBuilder('casherom', '#finMainForma', '[data-cashe-rom-finance-container]');
          utils.clearContainer(financeContainer);
          financeForm.build();
          financeForm.borderTopOn();
          formUpdater.finance();
          utils.toggleContainers(financeContainer, awContainer, true, false);
          Object.assign(formState, { isFinanceVisible: true, isAwVisible: false });
        },
        showAw: () => { // Показ AW-форми
          const awForm = new AWFormBuilder('casherom-aw', '#AwMainForma', '[data-cashe-rom-aw-container]');
          utils.clearContainer(awContainer);
          awForm.render(customStyles);
          awForm.borderTopOn();
          const elements = formUpdater.aw();
          utils.applyStyles(elements.wasteAw?.parentElement, customStyles.wasteField);
          document.querySelectorAll('.col').forEach(col => {
            if (col.querySelector('#summaPrivat-casherom-aw') && col.querySelector('#costPrivat-casherom-aw') && 
                col.closest('#casherom-aw-form-0')) {
              utils.applyStyles(col, { display: 'none' });
            }
          });
          // Приховування додаткових елементів AW-форми
          ['#buttonWasteTab-casherom-aw', '#buttonArrivalTab-casherom-aw'].forEach(selector => {
            const button = document.querySelector(selector);
            if (button) utils.applyStyles(button, { display: 'none' });
          });
          hideWorkersInAwContainer();
          utils.toggleContainers(financeContainer, awContainer, false, true);
          Object.assign(formState, { isAwVisible: true, isFinanceVisible: false });
        },
        save: () => { // Збереження даних
          const dataModal = formaCassheRom.formaDataObj();
          google.script.run.setRecordsCasheRom(dataModal);
          dialog.close();
        }
      };
  
      utils.extractProjectNumber(articleValue) ? formActions.showFinance() : formActions.showAw();
  
      document.querySelector('.modal-casherom__btn')?.addEventListener('click', formActions.save);
      document.querySelector('.modal-casherom__btn--monovit')?.addEventListener('click', () => {
        utils.setInputValue(document.querySelector('#casheInputNotes'), 'відшкодовано на МОНО ВІТ');
        formaCassheRom.labelred();
      });
      document.querySelector('[data-cashe-rom-forma-container]')?.addEventListener('keypress', e => {
        if (e.keyCode === 13) formActions.save();
      });
    }
  
    const toggleForm = (selector, builder, updateFn, visibleKey, otherKey) => { // Перемикання видимості форм
      const form = new builder('casherom' + (selector.includes('arriwalwaste') ? '-aw' : ''),
        selector.includes('finance') ? '#finMainForma' : '#AwMainForma',
        `[data-cashe-rom-${selector.includes('finance') ? 'finance' : 'aw'}-container]`);
      if (!formState[visibleKey]) {
        utils.clearContainer(selector.includes('finance') ? financeContainer : awContainer);
        selector.includes('finance') ? form.build() : form.render(customStyles);
        form.borderTopOn();
        const elements = updateFn();
        if (selector.includes('arriwalwaste')) {
          utils.applyStyles(elements.wasteAw?.parentElement, customStyles.wasteField);
          document.querySelectorAll('.col').forEach(col => {
            if (col.querySelector('#summaPrivat-casherom-aw') && col.querySelector('#costPrivat-casherom-aw') && 
                col.closest('#casherom-aw-form-0')) {
              utils.applyStyles(col, { display: 'none' });
            }
          });
          // Приховування додаткових елементів AW-форми
          ['#buttonWasteTab-casherom-aw', '#buttonArrivalTab-casherom-aw'].forEach(selector => {
            const button = document.querySelector(selector);
            if (button) utils.applyStyles(button, { display: 'none' });
          });
          hideWorkersInAwContainer();
        }
        utils.toggleContainers(financeContainer, awContainer, selector.includes('finance'), !selector.includes('finance'));
        Object.assign(formState, { [visibleKey]: true, [otherKey]: false });
      } else {
        form.none();
        form.borderTopOff();
        utils.clearContainer(selector.includes('finance') ? financeContainer : awContainer);
        utils.toggleContainers(financeContainer, awContainer, false, false);
        formState[visibleKey] = false;
      }
    };
  
    if (e.target.matches('.modal-casherom__btn--finance')) {
      toggleForm('finance', FinanceFormBuilder, formUpdater.finance, 'isFinanceVisible', 'isAwVisible');
    }
    if (e.target.matches('.modal-casherom__btn--arriwalwaste')) {
      toggleForm('arriwalwaste', AWFormBuilder, formUpdater.aw, 'isAwVisible', 'isFinanceVisible');
    }
  });
  
  // Ініціалізація таблиці
  buildDataTableCasherom();
  
  </script>