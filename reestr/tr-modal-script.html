<script>
  (function () {
    const CACHE_KEY = 'buhModalFormCache';
    const modalBodySelector = '#sendBuhModal';
    const formSelector = '#sendBuhModalForm';
    const previewSelector = '.modal-mailbuh-mail';
    const sendStatusSelector = '.modal-mailbuh-mail-send-text';

    let sendMail = '';
    let buhproekt = '';
    let formDataInstance = null;

    // HTML-шаблон форми
    const htmlTemplate = `
      <form id="sendBuhModalForm">
        <div class="row my-1">
          <div class="col-2">
            <label for="sendbuhproekt">Проєкт</label>
            <input type="number" name="sendbuhproekt" id="sendbuhproekt" class="form-control fw-bold">
          </div>
          <div class="col-2">
            <label for="sendbuhforma">Форма</label>
            <select class="form-control" name="sendbuhforma" id="sendbuhforma">
              <option>ФОП</option>
              <option>ТОВ</option>
              <option></option>
            </select>
          </div>
          <div class="col-auto">
            <label for="sendbuhsumma">Сума</label>
            <input type="number" name="sendbuhsumma" id="sendbuhsumma" class="form-control">
          </div>
          <div class="col-2">
            <label for="sendbuhcurrency">Валюта</label>
            <select class="form-control" name="sendbuhcurrency" id="sendbuhcurrency">
              <option>грн</option>
              <option>$</option>
              <option>євро</option>
              <option></option>
            </select>
          </div>
          <div class="col-2">
            <label for="sendbuhvat">ПДВ</label>
            <select class="form-control" name="sendbuhvat" id="sendbuhvat">
              <option></option>
              <option>з ПДВ</option>
              <option>без ПДВ</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-10">
            <label for="sendbuhprim">Примітки</label>
            <input type="text" name="sendbuhprim" id="sendbuhprim" class="form-control">
          </div>
        </div>
        <hr>
        <div class="row mb-2">
          <div class="col position-relative">
            <label for="sendbuhcont">Контакти</label>
            <textarea name="sendbuhcont" id="sendbuhcont" class="form-control mt-2"></textarea>
            <div class="form-check position-absolute top-0 start-50">
              <input type="checkbox" name="free_text" id="free_text" class="form-check-input">
              <label for="free_text" class="form-check-label">Вільний текст</label>
            </div>
          </div>
        </div>
      </form>
      <div class="modal-mailbuh-mail"></div>        
      <div class="modal-mailbuh-mail-send-text" id="modalMailbuhMailSendText"></div>
    `;

    // Утиліти
    const $ = (selector, context = document) => context.querySelector(selector);
    const $$ = (selector, context = document) => context.querySelectorAll(selector);

    const saveToCache = (data) => {
      const { sendbuhproekt, ...cacheableData } = data;
      localStorage.setItem(CACHE_KEY, JSON.stringify(cacheableData));
    };

    const loadFromCache = () => {
      const cached = localStorage.getItem(CACHE_KEY);
      return cached ? JSON.parse(cached) : null;
    };

    const clearCache = () => localStorage.removeItem(CACHE_KEY);

    const numEndStrong = (text) => {
      const match = text.match(/(\d+)$/);
      return match ? match[0] : '';
    };

    const updatePreview = () => {
      if (!formDataInstance) return;
      const data = formDataInstance.formaDataObj();
      const {
        sendbuhproekt, sendbuhsumma, sendbuhcurrency, sendbuhforma,
        sendbuhvat, sendbuhprim, sendbuhcont, free_text
      } = data;

      let body = `<p style="font-size: 1.1rem;">Проєкт: пр${sendbuhproekt}`;

      if (!free_text) {
        if (sendbuhsumma) {
          body += `<br>${sendbuhsumma} ${sendbuhcurrency} з ${sendbuhforma}`;
          if (sendbuhforma.toLowerCase() !== 'фоп') {
            body += ` ${sendbuhvat}`;
          }
        } else {
          body += `<br>${sendbuhcont}`;
        }
        if (sendbuhprim) body += `<br>${sendbuhprim}`;
        if (sendbuhcont && sendbuhsumma) {
          body += `<br>${sendbuhcont.replace(/--/g, '<br>')}`;
        }
      } else {
        body += `<br>${sendbuhcont.replace(/--/g, '<br>')}`;
      }
      body += `</p>`;

      $(previewSelector).innerHTML = body;
      sendMail = body;
      buhproekt = sendbuhproekt;
    };

    const sendEmail = () => {
      const statusEl = $(sendStatusSelector);
      if (statusEl) statusEl.innerHTML = '<p style="color:#6c757d; text-align:center;">Відправляємо...</p>';

      google.script.run
        .withSuccessHandler(() => {
          const modalBody = $('.modal-mailbuh-body');
          const projectNumber = $('#sendbuhproekt', modalBody)?.value.trim();

          const statusEl = $(sendStatusSelector);
          if (statusEl) {
            statusEl.innerHTML = `
              <p style="font-size:1.1rem; color:#198754; font-weight:700; text-align:center;">
                Відправлено
              </p>`;
          }

          clearCache();

          const form = $(formSelector, modalBody);
          if (form) {
            form.reset();
            const projectInput = $('#sendbuhproekt', modalBody);
            if (projectInput) projectInput.value = projectNumber;
            const freeTextCheckbox = $('#free_text', modalBody);
            if (freeTextCheckbox) freeTextCheckbox.checked = false;
          }

          $(previewSelector, modalBody).innerHTML = '';
          formDataInstance = new FormDataFromTables(formSelector);
          updatePreview();

          setTimeout(() => {
            const modalEl = $(modalBodySelector);
            if (modalEl && bootstrap?.Modal) {
              const modalInstance = bootstrap.Modal.getInstance(modalEl);
              if (modalInstance) modalInstance.hide();
            }
          }, 1200);
        })
        .withFailureHandler((e) => {
          try {
            if (e?.authUrl) {
              window.open(e.authUrl, '_blank');
              return;
            }
          } catch (_) { }
          alert('Не вдалося надіслати лист: ' + (e?.message || e));
          $(sendStatusSelector).innerHTML = '';
        })
        .sendEmailBuhInvoice(buhproekt, sendMail);
    };

    // === Відкриття модального вікна ===
    $('#btnSendMail').addEventListener('click', (event) => {
      const modalBody = $('.modal-mailbuh-body');
      modalBody.innerHTML = htmlTemplate;

      // Вставляємо номер проєкту
      $('#sendbuhproekt').value = numEndStrong(event.target.innerHTML);

      // Ініціалізуємо форму
      formDataInstance = new FormDataFromTables(formSelector);

      // Відновлюємо кешовані дані (окрім проєкту)
      const cached = loadFromCache();
      if (cached) {
        Object.keys(cached).forEach(key => {
          const el = $(`[name="${key}"]`, modalBody);
          if (el) {
            if (el.type === 'checkbox') {
              el.checked = cached[key];
            } else {
              el.value = cached[key];
            }
          }
        });
      }

      // Оновлюємо прев’ю
      updatePreview();

      // Слухаємо зміни
      const modal = $(modalBodySelector);
      ['input', 'change', 'keyup'].forEach(evt => {
        modal.addEventListener(evt, () => {
          updatePreview();
          saveToCache(formDataInstance.formaDataObj());
        });
      });
    });

    // === Кнопка відправки ===
    document.addEventListener('click', (e) => {
      if (e.target.id === 'btnSendBuh') {
        sendEmail();
      }
    });

    // === Ctrl + Enter ===
    $(modalBodySelector)?.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        sendEmail();
      }
    });

    // === Відстеження закриття модалки (Bootstrap) ===
    $(modalBodySelector)?.addEventListener('hidden.bs.modal', () => {
      if (formDataInstance) {
        saveToCache(formDataInstance.formaDataObj());
      }
    });

    /// === Кнопка очищення кешу ===//
    document.addEventListener('click', (e) => {
      if (e.target.id === 'btnClearBuhCache') {
        const modalBody = $('.modal-mailbuh-body');
        const projectNumber = $('#sendbuhproekt', modalBody)?.value.trim();

        // 1. Очищаємо всі поля, крім проєкту
        const form = $(formSelector, modalBody);
        if (form) {
          // Очищаємо всі поля
          form.reset();

          // Повертаємо номер проєкту
          const projectInput = $('#sendbuhproekt', modalBody);
          if (projectInput) projectInput.value = projectNumber;

          // Скидаємо checkbox
          const freeTextCheckbox = $('#free_text', modalBody);
          if (freeTextCheckbox) freeTextCheckbox.checked = false;
        }

        // 2. Очищаємо прев’ю та статус
        $(previewSelector, modalBody).innerHTML = '';
        $(sendStatusSelector, modalBody).innerHTML = '';

        // 3. Очищаємо кеш (localStorage)
        clearCache();

        // 4. Переініціалізуємо FormDataFromTables
        formDataInstance = new FormDataFromTables(formSelector);

        // 5. Оновлюємо прев’ю (тільки з номером проєкту)
        updatePreview();

        // 6. Повідомлення
        const statusEl = $(sendStatusSelector, modalBody);
        if (statusEl) {
          statusEl.innerHTML = '<p style="color:#6c757d; text-align:center; font-size:0.9rem;">Поля очищено (проєкт збережено)</p>';
          setTimeout(() => statusEl.innerHTML = '', 1800);
        }
      }
    });

  })();
</script>