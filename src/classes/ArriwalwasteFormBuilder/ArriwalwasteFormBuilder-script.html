<script>
class AWFormBuilder extends FormBuilderBase {
  defaultName = 'aw';

  attributes = {
    wasteButton: 'data-button-waste',
    arrivalButton: 'data-button-arrival',
    wasteTabButton: 'data-button-wastetab',
    arrivalTabButton: 'data-button-arrivaltab',
    yesterdayButton: 'btnArriwalwasteY-casherom-aw',
    fridayButton: 'btnArriwalwasteFri-casherom-aw',
    todayButton: 'btnArriwalwasteT-casherom-aw'
  };

  selectors = {
    form: '[data-form-aw]',
    awBody: '.aw-body',
    awButtonsContainer: '.aw-buttons-container',
    dateInput: '#date-casherom-aw'
  };

  constructor(name, templateSelector, containerSelector) {
    super(name, templateSelector, containerSelector);
  }

  render(customStyles = {}) {
    super.renderTemplate(customStyles);
    const forms = this.container.querySelectorAll(this.selectors.form);
    this.formInstances = Array.from(forms).map((form, index) => {
      if (!form.id) {
        form.id = `${this.name}-form-${index}`;
      }
      return new FormDataFromTables(`#${form.id}`);
    });
    this.initEventListeners();
    this.setDefaultDate();
  }

  applyCustomStyles(customStyles) {
    const awBody = this.container.querySelector(this.selectors.awBody);
    const awButtonsContainer = this.container.querySelector(this.selectors.awButtonsContainer);

    if (awBody && customStyles.awBody && Object.keys(customStyles.awBody).length > 0) {
      Object.entries(customStyles.awBody).forEach(([property, value]) => {
        awBody.style[property] = value;
      });
    }

    if (awButtonsContainer && customStyles.awButtonsContainer && Object.keys(customStyles.awButtonsContainer).length > 0) {
      Object.entries(customStyles.awButtonsContainer).forEach(([property, value]) => {
        awButtonsContainer.style[property] = value;
      });
    }
  }

  initEventListeners() {
    const wasteButton = this.container.querySelector(`[${this.attributes.wasteButton}]`);
    const arrivalButton = this.container.querySelector(`[${this.attributes.arrivalButton}]`);
    const wasteTabButton = this.container.querySelector(`[${this.attributes.wasteTabButton}]`);
    const arrivalTabButton = this.container.querySelector(`[${this.attributes.arrivalTabButton}]`);
    const yesterdayButton = this.container.querySelector(`#${this.attributes.yesterdayButton}`);
    const fridayButton = this.container.querySelector(`#${this.attributes.fridayButton}`);
    const todayButton = this.container.querySelector(`#${this.attributes.todayButton}`);

    if (wasteButton) wasteButton.addEventListener('click', this.handleWasteButtonClick.bind(this));
    if (arrivalButton) arrivalButton.addEventListener('click', this.handleArrivalButtonClick.bind(this));
    if (wasteTabButton) wasteTabButton.addEventListener('click', this.handleWasteTabButtonClick.bind(this));
    if (arrivalTabButton) arrivalTabButton.addEventListener('click', this.handleArrivalTabButtonClick.bind(this));
    if (yesterdayButton) yesterdayButton.addEventListener('click', this.handleYesterdayButtonClick.bind(this));
    if (fridayButton) fridayButton.addEventListener('click', this.handleFridayButtonClick.bind(this));
    if (todayButton) todayButton.addEventListener('click', this.handleTodayButtonClick.bind(this));
  }

  setDefaultDate() {
    const dateInput = this.container.querySelector(this.selectors.dateInput);
    if (dateInput) dateInput.valueAsDate = new Date();
  }

  handleYesterdayButtonClick(event) {
    const dateInput = this.container.querySelector(this.selectors.dateInput);
    if (dateInput) yesterdayFridayToday1(' Y ', dateInput);
    if (this.eventHandlers.yesterdayButton) this.eventHandlers.yesterdayButton(event);
  }

  handleFridayButtonClick(event) {
    const dateInput = this.container.querySelector(this.selectors.dateInput);
    if (dateInput) yesterdayFridayToday1('Fri', dateInput);
    if (this.eventHandlers.fridayButton) this.eventHandlers.fridayButton(event);
  }

  handleTodayButtonClick(event) {
    const dateInput = this.container.querySelector(this.selectors.dateInput);
    if (dateInput) yesterdayFridayToday1(' T ', dateInput);
    if (this.eventHandlers.todayButton) this.eventHandlers.todayButton(event);
  }

  toggleButtons(disabled) {
    const wasteButton = this.container.querySelector(`[${this.attributes.wasteButton}]`);
    const arrivalButton = this.container.querySelector(`[${this.attributes.arrivalButton}]`);
    if (wasteButton) wasteButton.disabled = disabled;
    if (arrivalButton) arrivalButton.disabled = disabled;
  }

  handleWasteButtonClick(event) {
    const rowData = this.getRowData();
    const termkarVal = document.getElementById("termkar-casherom-aw")?.value;

    if (!rowData[4] && !termkarVal) {
      alert('Не заповнена стаття витрат');
      return;
    }

    if (this.validateRowData(rowData)) return;

    this.toggleButtons(true);
    spinner("dataTableArriwalWaste");

    if (!this.getTermKarData()[4]) {
      google.script.run
        .withSuccessHandler((result) => {
          createTableArriwalWaste(result);
          this.toggleButtons(false);
          document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші витрати";
          this.clearForm();
          document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
        })
        .addNewRowWaste(rowData);
    } else {
      const termKarData = this.getTermKarData();
      google.script.run.insertTermKar(termKarData);
      google.script.run
        .withSuccessHandler((result) => {
          startDataWaste(result);
          this.toggleButtons(false);
          document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші витрати";
          this.clearForm();
          document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
        })
        .vReestrTerminalKarantin(termKarData);
    }

    if (this.eventHandlers.wasteButton) this.eventHandlers.wasteButton(event);
  }

  handleArrivalButtonClick(event) {
    const rowData = this.getRowData();
    if (this.validateRowData(rowData)) return;

    this.toggleButtons(true);
    spinner("dataTableArriwalWaste");

    google.script.run
      .withSuccessHandler((result) => {
        createTableArriwalWaste(result);
        document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші надходження";
        this.clearForm();
        document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
        this.toggleButtons(false);
      })
      .addNewRowArrival(rowData);

    google.script.run
      .withSuccessHandler((result) => {
        createTableArriwalWaste(result);
      })
      .addNewTableArriwal(rowData);

    if (this.eventHandlers.arrivalButton) this.eventHandlers.arrivalButton(event);
  }

  handleWasteTabButtonClick(event) {
    spinner("dataTableArriwalWaste");
    document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші витрати";
    createTableArriwalWaste(JSON.parse(localStorage.getItem('dataWaste')));
    document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
    startArrivalWaste();
    if (this.eventHandlers.wasteTabButton) this.eventHandlers.wasteTabButton(event);
  }

  handleArrivalTabButtonClick(event) {
    spinner("dataTableArriwalWaste");
    document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші надходження";
    createTableArriwalWaste(JSON.parse(localStorage.getItem('dataArrival')));
    document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
    startArrivalWaste();
    if (this.eventHandlers.arrivalTabButton) this.eventHandlers.arrivalTabButton(event);
  }

  getRowData() {
    const date = document.getElementById("date-casherom-aw")?.value;
    let summa = +document.getElementById("summa-casherom-aw")?.value || 0;
    const summaPrivat = +document.getElementById("summaPrivat-casherom-aw")?.value || 0;
    const costPrivat = +document.getElementById("costPrivat-casherom-aw")?.value || 0;
    let forma = document.getElementById("forma-casherom-aw")?.value;
    let firmaArrivalWaste = document.getElementById("firmaArrivalWaste-casherom-aw")?.value;
    let waste = document.getElementById("waste-casherom-aw")?.value;

    if (!summaPrivat && !summa) {
      summa = "";
      waste = "Не заповнено ні одного поля суми";
      firmaArrivalWaste = "";
    } else if (summaPrivat && !summa) {
      if (!costPrivat) {
        waste = "Не заповнено вартості комісії приват";
      } else {
        localStorage.setItem('costPrivat', costPrivat);
        summa = summaPrivat * costPrivat;
        waste = "Приват комісія";
        forma = "тов";
        firmaArrivalWaste = "";
      }
    }

    return [date, +summa, forma, firmaArrivalWaste, waste];
  }

  getTermKarData() {
    const date = document.getElementById("date-casherom-aw")?.value;
    const summa = document.getElementById("summa-casherom-aw")?.value;
    const forma = document.getElementById("forma-casherom-aw")?.value;
    const waste = document.getElementById("waste-casherom-aw")?.value;
    const termkar = document.getElementById("termkar-casherom-aw")?.value;
    const sftermkar = document.getElementById("sftermkar-casherom-aw")?.value;

    return [date, summa * 1, forma, waste, termkar, sftermkar];
  }

  validateRowData(rowData) {
    if (rowData[4] === "Не заповнено ні одного поля суми") {
      alert("Не заповнено ні одного поля суми");
      return true;
    }
    if (rowData[4] === "Заповнені обидва поля суми") {
      alert("Заповнені обидва поля суми");
      return true;
    }
    if (rowData[4] === "Не заповнено вартості комісії приват") {
      alert("Не заповнено вартості комісії приват");
      return true;
    }
    if (rowData[4] === "Не заповнена ціна привату") {
      alert("Не заповнена ціна привату");
      return true;
    }
    return false;
  }

  clearForm() {
    document.getElementById("summa-casherom-aw").value = "";
    document.getElementById("summaPrivat-casherom-aw").value = "";
    document.getElementById("firmaArrivalWaste-casherom-aw").value = "";
    document.getElementById("waste-casherom-aw").value = "";
    document.getElementById("termkar-casherom-aw").value = "";
    document.getElementById("sftermkar-casherom-aw").value = "";
  }
}
</script>