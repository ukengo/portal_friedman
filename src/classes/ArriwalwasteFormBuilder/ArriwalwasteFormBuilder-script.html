<script>

class AWFormBuilder extends FormBuilderBase {
  defaultName = 'aw';

  attributes = {
    wasteButton: 'data-button-waste',
    arrivalButton: 'data-button-arrival',
    wasteTabButton: 'data-button-wastetab',
    arrivalTabButton: 'data-button-arrivaltab',
    yesterdayButton: 'btnArriwalwasteY-casherom-aw',
    fridayButton: 'btnArriwalwasteFri-casherom-aw',
    todayButton: 'btnArriwalwasteT-casherom-aw'
  };

  selectors = {
    form: '[data-form-aw]',
    dateInput: '#date-casherom-aw'
  };

  constructor(name, templateSelector, containerSelector) {
    super(name, templateSelector, containerSelector);
  }

  render() {
    super.renderTemplate();
    this.formInstances = Array.from(this.container.querySelectorAll(this.selectors.form))
      .map((form, index) => {
        form.id = form.id || `${this.name}-form-${index}`;
        return new FormDataFromTables(`#${form.id}`);
      });
    this.initEventListeners();
    this.setDefaultDate();
  }

  initEventListeners() {
    const events = [
      [`[${this.attributes.wasteButton}]`, this.handleWasteButtonClick],
      [`[${this.attributes.arrivalButton}]`, this.handleArrivalButtonClick],
      [`[${this.attributes.wasteTabButton}]`, this.handleWasteTabButtonClick],
      [`[${this.attributes.arrivalTabButton}]`, this.handleArrivalTabButtonClick],
      [`#${this.attributes.yesterdayButton}`, this.handleYesterdayButtonClick],
      [`#${this.attributes.fridayButton}`, this.handleFridayButtonClick],
      [`#${this.attributes.todayButton}`, this.handleTodayButtonClick]
    ];

    events.forEach(([selector, handler]) => {
      const element = this.container.querySelector(selector);
      if (element) element.addEventListener('click', handler.bind(this));
    });
  }

  setDefaultDate() {
    const dateInput = this.container.querySelector(this.selectors.dateInput);
    if (dateInput) dateInput.valueAsDate = new Date();
  }

  handleYesterdayButtonClick(event) {
    this.setDate(' Y ');
    this.eventHandlers.yesterdayButton?.(event);
  }

  handleFridayButtonClick(event) {
    this.setDate('Fri');
    this.eventHandlers.fridayButton?.(event);
  }

  handleTodayButtonClick(event) {
    this.setDate(' T ');
    this.eventHandlers.todayButton?.(event);
  }

  setDate(type) {
    const dateInput = this.container.querySelector(this.selectors.dateInput);
    if (dateInput) yesterdayFridayToday1(type, dateInput);
  }

  toggleButtons(disabled) {
    const buttons = [
      `[${this.attributes.wasteButton}]`,
      `[${this.attributes.arrivalButton}]`
    ];
    buttons.forEach(selector => {
      const button = this.container.querySelector(selector);
      if (button) button.disabled = disabled;
    });
  }

  handleWasteButtonClick(event) {
    const rowData = this.getRowData();
    const termkarVal = document.getElementById("termkar-casherom-aw")?.value;

    if (!rowData[4] && !termkarVal) return alert('Не заповнена стаття витрат');
    if (this.validateRowData(rowData)) return;

    this.toggleButtons(true);
    spinner("dataTableArriwalWaste");

    const termKarData = this.getTermKarData();
    const action = !termKarData[4]
      ? google.script.run.addNewRowWaste(rowData)
      : Promise.all([
          google.script.run.insertTermKar(termKarData),
          google.script.run.vReestrTerminalKarantin(termKarData)
        ]).then(() => startDataWaste);

    action.withSuccessHandler(result => {
      createTableArriwalWaste(result);
      this.toggleButtons(false);
      document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші витрати";
      this.clearForm();
      document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
    });

    this.eventHandlers.wasteButton?.(event);
  }

  handleArrivalButtonClick(event) {
    const rowData = this.getRowData();
    if (this.validateRowData(rowData)) return;

    this.toggleButtons(true);
    spinner("dataTableArriwalWaste");

    google.script.run
      .withSuccessHandler(result => {
        createTableArriwalWaste(result);
        document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші надходження";
        this.clearForm();
        document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
        this.toggleButtons(false);
      })
      .addNewRowArrival(rowData);

    google.script.run
      .withSuccessHandler(createTableArriwalWaste)
      .addNewTableArriwal(rowData);

    this.eventHandlers.arrivalButton?.(event);
  }

  handleWasteTabButtonClick(event) {
    spinner("dataTableArriwalWaste");
    document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші витрати";
    createTableArriwalWaste(JSON.parse(localStorage.getItem('dataWaste')));
    document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
    startArrivalWaste();
    this.eventHandlers.wasteTabButton?.(event);
  }

  handleArrivalTabButtonClick(event) {
    spinner("dataTableArriwalWaste");
    document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші надходження";
    createTableArriwalWaste(JSON.parse(localStorage.getItem('dataArrival')));
    document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
    startArrivalWaste();
    this.eventHandlers.arrivalTabButton?.(event);
  }

  getRowData() {
    const fields = {
      date: "date-casherom-aw",
      summa: "summa-casherom-aw",
      summaPrivat: "summaPrivat-casherom-aw",
      costPrivat: "costPrivat-casherom-aw",
      forma: "forma-casherom-aw",
      firmaArrivalWaste: "firmaArrivalWaste-casherom-aw",
      waste: "waste-casherom-aw"
    };

    const values = Object.fromEntries(
      Object.entries(fields).map(([key, id]) => [key, document.getElementById(id)?.value])
    );

    let { date, summa, summaPrivat, costPrivat, forma, firmaArrivalWaste, waste } = values;
    summa = +summa || 0;
    summaPrivat = +summaPrivat || 0;
    costPrivat = +costPrivat || 0;

    if (!summaPrivat && !summa) {
      summa = "";
      waste = "Не заповнено ні одного поля суми";
      firmaArrivalWaste = "";
    } else if (summaPrivat && !summa) {
      if (!costPrivat) {
        waste = "Не заповнено вартості комісії приват";
      } else {
        localStorage.setItem('costPrivat', costPrivat);
        summa = summaPrivat * costPrivat;
        waste = "Приват комісія";
        forma = "тов";
        firmaArrivalWaste = "";
      }
    }

    return [date, +summa, forma, firmaArrivalWaste, waste];
  }

  getTermKarData() {
    const fields = {
      date: "date-casherom-aw",
      summa: "summa-casherom-aw",
      forma: "forma-casherom-aw",
      waste: "waste-casherom-aw",
      termkar: "termkar-casherom-aw",
      sftermkar: "sftermkar-casherom-aw"
    };

    const values = Object.fromEntries(
      Object.entries(fields).map(([key, id]) => [key, document.getElementById(id)?.value])
    );

    return [
      values.date,
      values.summa * 1,
      values.forma,
      values.waste,
      values.termkar,
      values.sftermkar
    ];
  }

  validateRowData(rowData) {
    const messages = {
      "Не заповнено ні одного поля суми": "Не заповнено ні одного поля суми",
      "Заповнені обидва поля суми": "Заповнені обидва поля суми",
      "Не заповнено вартості комісії приват": "Не заповнено вартості комісії приват",
      "Не заповнена ціна привату": "Не заповнена ціна привату"
    };

    if (messages[rowData[4]]) {
      alert(messages[rowData[4]]);
      return true;
    }
    return false;
  }

  clearForm() {
    const ids = [
      "summa-casherom-aw",
      "summaPrivat-casherom-aw",
      "firmaArrivalWaste-casherom-aw",
      "waste-casherom-aw",
      "termkar-casherom-aw",
      "sftermkar-casherom-aw"
    ];
    ids.forEach(id => {
      const element = document.getElementById(id);
      if (element) element.value = "";
    });
  }
}

</script>