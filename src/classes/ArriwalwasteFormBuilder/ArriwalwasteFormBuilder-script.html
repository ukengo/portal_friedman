<script>

class AWFormBuilder extends FormBuilderBase {
  defaultName = 'aw';

  attributes = {
    wasteButton: 'data-button-waste',
    arrivalButton: 'data-button-arrival',
    wasteTabButton: 'data-button-wastetab',
    arrivalTabButton: 'data-button-arrivaltab',
  };

  selectors = {
    form: '[data-form-aw]',
    dateInput: null,
    dateButtonGroup: '.btn-group',
    yesterdayButton: '.btn-yft[value=" Y "]',
    fridayButton: '.btn-yft[value="Fri"]',
    todayButton: '.btn-yft[value=" T "]',
  };

  constructor(name, templateSelector, containerSelector) {
    super(name, templateSelector, containerSelector);
    this.selectors.dateInput = name === 'aw' ? '#date' : `#date-${name}`;
    console.log(`AWFormBuilder initialized for container: ${containerSelector}`);
  }

  getFormFields() {
    return {
      date: this.name === 'aw' ? 'date' : `date-${this.name}`,
      summa: this.name === 'aw' ? 'summa' : `summa-${this.name}`,
      summaPrivat: this.name === 'aw' ? 'summaPrivat' : `summaPrivat-${this.name}`,
      costPrivat: this.name === 'aw' ? 'costPrivat' : `costPrivat-${this.name}`,
      forma: this.name === 'aw' ? 'forma' : `forma-${this.name}`,
      firmaArrivalWaste: this.name === 'aw' ? 'firmaArrivalWaste' : `firmaArrivalWaste-${this.name}`,
      waste: this.name === 'aw' ? 'waste' : `waste-${this.name}`,
      termkar: this.name === 'aw' ? 'termkar' : `termkar-${this.name}`,
      sftermkar: this.name === 'aw' ? 'sftermkar' : `sftermkar-${this.name}`,
    };
  }

  render() {
    console.log('Rendering AWFormBuilder');
    if (!this.checkTemplateAndContainer()) return;
    super.renderTemplate();
    this.formInstances = Array.from(this.container.querySelectorAll(this.selectors.form)).map(
      (form, index) => {
        form.id = form.id || `${this.name}-form-${index}`;
        return new FormDataFromTables(`#${form.id}`);
      }
    );
    this.initEventListeners();
    this.setDefaultDate();
    this.resetLabelColors(this.getFormFields());
  }

  initEventListeners() {
    const events = [
      [`[${this.attributes.wasteButton}]`, this.handleWasteButtonClick, 'Кнопка Витрата'],
      [`[${this.attributes.arrivalButton}]`, this.handleArrivalButtonClick, 'Кнопка Прихід'],
      [this.selectors.yesterdayButton, this.handleYesterdayButtonClick, 'Кнопка Вчора'],
      [this.selectors.fridayButton, this.handleFridayButtonClick, 'Кнопка П\'ятниця'],
      [this.selectors.todayButton, this.handleTodayButtonClick, 'Кнопка Сьогодні'],
    ];
    events.forEach(([selector, handler, description]) => {
      const elements = this.container.querySelectorAll(selector);
      console.log(`Binding events for ${description}: found ${elements.length} elements`);
      elements.forEach((element) => {
        element.addEventListener('click', (event) => {
          console.log(`Event triggered: ${description}`);
          handler.call(this, event);
        });
      });
    });
  }

  setDefaultDate() {
    const dateInputs = this.container.querySelectorAll(this.selectors.dateInput);
    if (dateInputs.length === 0) {
      console.warn(`No date inputs found for selector: ${this.selectors.dateInput}`);
      return;
    }
    dateInputs.forEach((dateInput) => {
      const today = new Date();
      dateInput.value = today.toISOString().split('T')[0];
      console.log(`Set default date: ${dateInput.value}`);
    });
    this.updateLabelColors(this.getFormFields());
  }

  handleYesterdayButtonClick(event) {
    this.setDate('yesterday');
    this.updateLabelColors(this.getFormFields());
    this.eventHandlers.yesterdayButton?.(event);
  }

  handleFridayButtonClick(event) {
    this.setDate('friday');
    this.updateLabelColors(this.getFormFields());
    this.eventHandlers.fridayButton?.(event);
  }

  handleTodayButtonClick(event) {
    this.setDate('today');
    this.updateLabelColors(this.getFormFields());
    this.eventHandlers.todayButton?.(event);
  }

  setDate(type) {
    const dateInputs = this.container.querySelectorAll(this.selectors.dateInput);
    if (dateInputs.length === 0) return;
    dateInputs.forEach((dateInput) => {
      let targetDate = new Date();
      if (type === 'yesterday') {
        targetDate.setDate(targetDate.getDate() - 1);
      } else if (type === 'friday') {
        while (targetDate.getDay() !== 5) {
          targetDate.setDate(targetDate.getDate() - 1);
        }
      }
      dateInput.value = targetDate.toISOString().split('T')[0];
      console.log(`Set date (${type}): ${dateInput.value}`);
    });
  }

  updateLabelColors(fields) {
    Object.entries(fields).forEach(([key, id]) => {
      const input = this.container.querySelector(`#${id}`);
      const label = this.container.querySelector(`label[for="${id}"]`);
      if (!input || !label) {
        console.warn(`Input or label not found for id: ${id}`);
        return;
      }
      if (['date', 'costPrivat', 'forma'].includes(key)) {
        label.style.color = this.colors.errorColor;
      } else {
        label.style.removeProperty('color');
      }
    });
  }

  resetLabelColors(fields) {
    this.updateLabelColors(fields);
  }

  toggleButtons(disabled) {
    const buttons = [
      `[${this.attributes.wasteTabButton}]`,
      `[${this.attributes.arrivalTabButton}]`,
    ];
    buttons.forEach((selector) => {
      const button = this.container.querySelector(selector);
      if (button) {
        button.disabled = disabled;
      }
    });
  }

  handleWasteButtonClick(event) {
    const rowData = this.getRowData();
    const termkarVal = this.container.querySelector(`#termkar`)?.value;

    if (!rowData[4] && !termkarVal) {
      alert('Не заповнена стаття витрат');
      return;
    }
    if (this.validateRowData(rowData)) return;

    this.clearForm();
    this.updateLabelColors(this.getFormFields());

    const termKarData = this.getTermKarData();
    const successCallback = (result) => {
      console.log('Waste success:', result);
      createTableArriwalWaste(result);
      const header = this.container.querySelector('#vrabotevseArriwalWaste');
      if (header) header.innerHTML = 'Інші витрати';
      const tableDiv = this.container.querySelector('#divDataTableArriwalWaste');
      if (tableDiv) {
        tableDiv.style.height = 'auto';
        tableDiv.style.display = 'block';
        tableDiv.style.visibility = 'visible';
      }
    };
    const failureCallback = (error) => {
      console.error('Waste operation failed:', error);
      alert('Помилка збереження витрат: ' + error);
    };

    if (!termKarData[4]) {
      google.script.run
        .withSuccessHandler(successCallback)
        .withFailureHandler(failureCallback)
        .addNewRowWaste(rowData);
    } else {
      google.script.run
        .withSuccessHandler(() => {
          google.script.run
            .withSuccessHandler(() => {
              startDataWaste();
              successCallback(null);
            })
            .withFailureHandler(failureCallback)
            .vReestrTerminalKarantin(termKarData);
        })
        .withFailureHandler(failureCallback)
        .insertTermKar(termKarData);
    }

    this.eventHandlers.wasteButton?.(event);
  }

  handleArrivalButtonClick(event) {
    const rowData = this.getRowData();
    if (this.validateRowData(rowData)) return;

    this.clearForm();
    this.updateLabelColors(this.getFormFields());

    google.script.run
      .withSuccessHandler((result) => {
        console.log('Arrival success:', result);
        createTableArriwalWaste(result);
        const header = this.container.querySelector('#vrabotevseArriwalWaste');
        if (header) header.innerHTML = 'Інші надходження';
        const tableDiv = this.container.querySelector('#divDataTableArriwalWaste');
        if (tableDiv) {
          tableDiv.style.height = 'auto';
          tableDiv.style.display = 'block';
          tableDiv.style.visibility = 'visible';
        }
      })
      .withFailureHandler((error) => {
        console.error('Arrival operation failed:', error);
        alert('Помилка збереження надходжень: ' + error);
      })
      .addNewRowArrival(rowData);

    google.script.run
      .withSuccessHandler(createTableArriwalWaste)
      .addNewTableArriwal(rowData);

    this.eventHandlers.arrivalButton?.(event);
  }

  getRowData() {
    const fields = this.getFormFields();
    const values = Object.fromEntries(
      Object.entries(fields).map(([key, id]) => [
        key,
        this.container.querySelector(`#${id}`)?.value,
      ])
    );

    let { date, summa, summaPrivat, costPrivat, forma, firmaArrivalWaste, waste } = values;

    summa = summa ? +summa : undefined;
    summaPrivat = summaPrivat ? +summaPrivat : undefined;
    costPrivat = costPrivat ? +costPrivat : undefined;

    if (!summaPrivat && !summa) {
      summa = '';
      waste = 'Не заповнено ні одного поля суми';
      firmaArrivalWaste = '';
    } else if (summaPrivat && !summa) {
      if (!costPrivat) {
        waste = 'Не заповнено вартості комісії приват';
      } else {
        localStorage.setItem('costPrivat', costPrivat);
        summa = summaPrivat * costPrivat;
        waste = 'Приват комісія';
        forma = 'тов';
        firmaArrivalWaste = '';
      }
    } else if (summa && summaPrivat) {
      waste = 'Заповнені обидва поля суми';
    }

    return [date, summa || 0, forma, firmaArrivalWaste, waste];
  }

  getTermKarData() {
    const fields = this.getFormFields();
    const values = Object.fromEntries(
      Object.entries(fields).map(([key, id]) => [
        key,
        this.container.querySelector(`#${id}`)?.value,
      ])
    );

    return [
      values.date,
      values.summa * 1,
      values.forma,
      values.waste,
      values.termkar,
      values.sftermkar,
    ];
  }

  validateRowData(rowData) {
    const messages = {
      'Не заповнено ні одного поля суми': 'Не заповнено ні одного поля суми',
      'Заповнені обидва поля суми': 'Заповнені обидва поля суми',
      'Не заповнено вартості комісії приват': 'Не заповнено вартості комісії приват',
      'Не заповнена ціна привату': 'Не заповнена ціна привату',
    };

    if (messages[rowData[4]]) {
      alert(messages[rowData[4]]);
      return true;
    }
    return false;
  }

  clearForm() {
    const fields = this.getFormFields();
    const fieldsToClear = [
      fields.summa,
      fields.summaPrivat,
      fields.firmaArrivalWaste,
      fields.waste,
      fields.termkar,
      fields.sftermkar,
    ];

    fieldsToClear.forEach((id) => {
      const element = this.container.querySelector(`#${id}`);
      if (element) {
        element.value = '';
      } else {
        console.warn(`Field not found: ${id}`);
      }
    });

    this.updateLabelColors(this.getFormFields());
  }
}

</script>/