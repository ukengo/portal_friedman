<script>

// Клас AWFormBuilder для створення та управління формами фінансових операцій
class AWFormBuilder extends FormBuilderBase {
  // Назва за замовчуванням для форми
  defaultName = 'aw';

  // Атрибути для елементів форми
  attributes = {
    wasteButton: 'data-button-waste',
    arrivalButton: 'data-button-arrival',
    wasteTabButton: 'data-button-wastetab',
    arrivalTabButton: 'data-button-arrivaltab'
  };

  // Селектори для елементів форми
  selectors = {
    form: '[data-form-aw]',
    dateInput: null, // Буде встановлено в конструкторі
    dateButtonGroup: '.btn-group', // Група кнопок дати
    yesterdayButton: '.btn-yft[value=" Y "]',
    fridayButton: '.btn-yft[value="Fri"]',
    todayButton: '.btn-yft[value=" T "]'
  };

  // Конструктор класу
  constructor(name, templateSelector, containerSelector) {
    super(name, templateSelector, containerSelector);
    // Встановлення селектора для поля дати залежно від імені форми
    this.selectors.dateInput = name === 'aw' ? '#date' : `#date-${name}`;
  }

  // Рендеринг форми
  render() {
    if (!this.checkTemplateAndContainer()) return;
    super.renderTemplate();
    // Ініціалізація екземплярів форм
    this.formInstances = Array.from(this.container.querySelectorAll(this.selectors.form))
      .map((form, index) => {
        form.id = form.id || `${this.name}-form-${index}`;
        return new FormDataFromTables(`#${form.id}`);
      });
    this.initEventListeners();
    this.setDefaultDate();
  }

  // Ініціалізація обробників подій
  initEventListeners() {
    const events = [
      [`[${this.attributes.wasteButton}]`, this.handleWasteButtonClick, 'Кнопка Витрата'],
      [`[${this.attributes.arrivalButton}]`, this.handleArrivalButtonClick, 'Кнопка Прихід'],
      [`[${this.attributes.wasteTabButton}]`, this.handleWasteTabButtonClick, 'Кнопка Вкладка Витрати'],
      [`[${this.attributes.arrivalTabButton}]`, this.handleArrivalTabButtonClick, 'Кнопка Вкладка Надходження'],
      [this.selectors.yesterdayButton, this.handleYesterdayButtonClick, 'Кнопка Вчора'],
      [this.selectors.fridayButton, this.handleFridayButtonClick, 'Кнопка П\'ятниця'],
      [this.selectors.todayButton, this.handleTodayButtonClick, 'Кнопка Сьогодні']
    ];

    // Прив’язка обробників до елементів
    events.forEach(([selector, handler]) => {
      const elements = this.container.querySelectorAll(selector);
      elements.forEach(element => {
        element.addEventListener('click', (event) => {
          handler.call(this, event);
        });
      });
    });
  }

  // Встановлення дати за замовчуванням (поточна дата)
  setDefaultDate() {
    const dateInputs = this.container.querySelectorAll(this.selectors.dateInput);
    if (dateInputs.length === 0) return;
    dateInputs.forEach(dateInput => {
      if (dateInput) {
        const today = new Date();
        dateInput.value = today.toISOString().split('T')[0]; // Формат YYYY-MM-DD
      }
    });
  }

  // Обробник кнопки "Вчора"
  handleYesterdayButtonClick(event) {
    this.setDate('yesterday');
    this.eventHandlers.yesterdayButton?.(event);
  }

  // Обробник кнопки "П'ятниця"
  handleFridayButtonClick(event) {
    this.setDate('friday');
    this.eventHandlers.fridayButton?.(event);
  }

  // Обробник кнопки "Сьогодні"
  handleTodayButtonClick(event) {
    this.setDate('today');
    this.eventHandlers.todayButton?.(event);
  }

  // Встановлення дати в залежності від типу
  setDate(type) {
    const dateInputs = this.container.querySelectorAll(this.selectors.dateInput);
    if (dateInputs.length === 0) return;
    dateInputs.forEach(dateInput => {
      if (dateInput) {
        let targetDate = new Date();
        if (type === 'yesterday') {
          targetDate.setDate(targetDate.getDate() - 1);
        } else if (type === 'friday') {
          while (targetDate.getDay() !== 5) {
            targetDate.setDate(targetDate.getDate() - 1);
          }
        }
        dateInput.value = targetDate.toISOString().split('T')[0]; // Формат YYYY-MM-DD
      }
    });
  }

  // Перемикання стану кнопок (активовано/деактивовано)
  toggleButtons(disabled) {
    const buttons = [
      `[${this.attributes.wasteButton}]`,
      `[${this.attributes.arrivalButton}]`
    ];
    buttons.forEach(selector => {
      const button = this.container.querySelector(selector);
      if (button) {
        button.disabled = disabled;
      }
    });
  }

  // Обробник кнопки "Витрата"
  handleWasteButtonClick(event) {
    const rowData = this.getRowData();
    const termkarVal = document.getElementById(`termkar-${this.name}`)?.value;

    if (!rowData[4] && !termkarVal) {
      alert('Не заповнена стаття витрат');
      return;
    }
    if (this.validateRowData(rowData)) return;

    this.toggleButtons(true);
    spinner("dataTableArriwalWaste");

    const termKarData = this.getTermKarData();
    const successCallback = (result) => {
      createTableArriwalWaste(result);
      this.toggleButtons(false);
      document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші витрати";
      this.clearForm();
      document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
    };
    const failureCallback = (error) => {
      this.toggleButtons(false);
    };

    if (!termKarData[4]) {
      // Якщо termKarData[4] порожнє, викликаємо addNewRowWaste
      google.script.run
        .withSuccessHandler(successCallback)
        .withFailureHandler(failureCallback)
        .addNewRowWaste(rowData);
    } else {
      // Якщо termKarData[4] заповнене, викликаємо insertTermKar, а потім vReestrTerminalKarantin
      google.script.run
        .withSuccessHandler(() => {
          google.script.run
            .withSuccessHandler(() => {
              startDataWaste();
              successCallback(null); // Викликаємо successCallback після завершення
            })
            .withFailureHandler(failureCallback)
            .vReestrTerminalKarantin(termKarData);
        })
        .withFailureHandler(failureCallback)
        .insertTermKar(termKarData);
    }

    this.eventHandlers.wasteButton?.(event);
  }

  // Обробник кнопки "Прихід"
  handleArrivalButtonClick(event) {
    const rowData = this.getRowData();
    if (this.validateRowData(rowData)) return;

    this.toggleButtons(true);
    spinner("dataTableArriwalWaste");

    google.script.run
      .withSuccessHandler(result => {
        createTableArriwalWaste(result);
        document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші надходження";
        this.clearForm();
        document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
        this.toggleButtons(false);
      })
      .addNewRowArrival(rowData);

    google.script.run
      .withSuccessHandler(createTableArriwalWaste)
      .addNewTableArriwal(rowData);

    this.eventHandlers.arrivalButton?.(event);
  }

  // Обробник вкладки "Витрати"
  handleWasteTabButtonClick(event) {
    spinner("dataTableArriwalWaste");
    document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші витрати";
    createTableArriwalWaste(JSON.parse(localStorage.getItem('dataWaste')));
    document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
    startArrivalWaste();
    this.eventHandlers.wasteTabButton?.(event);
  }

  // Обробник вкладки "Надходження"
  handleArrivalTabButtonClick(event) {
    spinner("dataTableArriwalWaste");
    document.getElementById("vrabotevseArriwalWaste").innerHTML = "Інші надходження";
    createTableArriwalWaste(JSON.parse(localStorage.getItem('dataArrival')));
    document.querySelector("#divDataTableArriwalWaste").style.height = "210%";
    startArrivalWaste();
    this.eventHandlers.arrivalTabButton?.(event);
  }

  // Отримання даних рядка форми
  getRowData() {
    const fields = {
      date: `date-${this.name}`,
      summa: `summa-${this.name}`,
      summaPrivat: `summaPrivat-${this.name}`,
      costPrivat: `costPrivat-${this.name}`,
      forma: `forma-${this.name}`,
      firmaArrivalWaste: `firmaArrivalWaste-${this.name}`,
      waste: `waste-${this.name}`
    };

    // Для форми aw поле date має ідентифікатор просто "date"
    if (this.name === 'aw') {
      fields.date = 'date';
    }

    const values = Object.fromEntries(
      Object.entries(fields).map(([key, id]) => [key, document.getElementById(id)?.value])
    );

    let { date, summa, summaPrivat, costPrivat, forma, firmaArrivalWaste, waste } = values;
    summa = +summa || 0;
    summaPrivat = +summaPrivat || 0;
    costPrivat = +costPrivat || 0;

    if (!summaPrivat && !summa) {
      summa = "";
      waste = "Не заповнено ні одного поля суми";
      firmaArrivalWaste = "";
    } else if (summaPrivat && !summa) {
      if (!costPrivat) {
        waste = "Не заповнено вартості комісії приват";
      } else {
        localStorage.setItem('costPrivat', costPrivat);
        summa = summaPrivat * costPrivat;
        waste = "Приват комісія";
        forma = "тов";
        firmaArrivalWaste = "";
      }
    }

    return [date, +summa, forma, firmaArrivalWaste, waste];
  }

  // Отримання даних для терміналу-карантину
  getTermKarData() {
    const fields = {
      date: `date-${this.name}`,
      summa: `summa-${this.name}`,
      forma: `forma-${this.name}`,
      waste: `waste-${this.name}`,
      termkar: `termkar-${this.name}`,
      sftermkar: `sftermkar-${this.name}`
    };

    // Для форми aw поле date має ідентифікатор просто "date"
    if (this.name === 'aw') {
      fields.date = 'date';
    }

    const values = Object.fromEntries(
      Object.entries(fields).map(([key, id]) => [key, document.getElementById(id)?.value])
    );

    return [
      values.date,
      values.summa * 1,
      values.forma,
      values.waste,
      values.termkar,
      values.sftermkar
    ];
  }

  // Валідація даних рядка
  validateRowData(rowData) {
    const messages = {
      "Не заповнено ні одного поля суми": "Не заповнено ні одного поля суми",
      "Заповнені обидва поля суми": "Заповнені обидва поля суми",
      "Не заповнено вартості комісії приват": "Не заповнено вартості комісії приват",
      "Не заповнена ціна привату": "Не заповнена ціна привату"
    };

    if (messages[rowData[4]]) {
      alert(messages[rowData[4]]);
      return true;
    }
    return false;
  }

  // Очищення форми
  clearForm() {
    const ids = [
      `summa-${this.name}`,
      `summaPrivat-${this.name}`,
      `firmaArrivalWaste-${this.name}`,
      `waste-${this.name}`,
      `termkar-${this.name}`,
      `sftermkar-${this.name}`
    ];

    // Для форми aw додаємо специфічні ідентифікатори
    if (this.name === 'aw') {
      ids[0] = 'summa';
      ids[1] = 'summaPrivat';
      ids[2] = 'firmaArrivalWaste';
      ids[3] = 'waste';
      ids[4] = 'termkar';
      ids[5] = 'sftermkar';
    }

    ids.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.value = "";
      }
    });
  }
}

</script>