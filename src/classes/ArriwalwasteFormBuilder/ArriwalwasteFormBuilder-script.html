<script>

class AWFormBuilder extends FormBuilderBase {
  defaultName = 'aw';

  attributes = {};

  selectors = {
    form: '[data-form-aw]',
    dateInput: null,
    dateButtonGroup: '.btn-group',
    yesterdayButton: '.btn-yft[value=" Y "]',
    fridayButton: '.btn-yft[value="Fri"]',
    todayButton: '.btn-yft[value=" T "]',
  };

  constructor(name, templateSelector, containerSelector) {
    super(name, templateSelector, containerSelector);
    this.selectors.dateInput = name === 'aw' ? '#date' : `#date-${name}`;
  }

  getFormFields() {
    return {
      date: this.name === 'aw' ? 'date' : `date-${this.name}`,
      summa: this.name === 'aw' ? 'summa' : `summa-${this.name}`,
      summaPrivat: this.name === 'aw' ? 'summaPrivat' : `summaPrivat-${this.name}`,
      costPrivat: this.name === 'aw' ? 'costPrivat' : `costPrivat-${this.name}`,
      forma: this.name === 'aw' ? 'forma' : `forma-${this.name}`,
      firmaArrivalWaste: this.name === 'aw' ? 'firmaArrivalWaste' : `firmaArrivalWaste-${this.name}`,
      waste: this.name === 'aw' ? 'waste' : `waste-${this.name}`,
      termkar: this.name === 'aw' ? 'termkar' : `termkar-${this.name}`,
      sftermkar: this.name === 'aw' ? 'sftermkar' : `sftermkar-${this.name}`,
    };
  }

  render() {
    if (!this.checkTemplateAndContainer()) return;
    super.renderTemplate();
    this.formInstances = Array.from(this.container.querySelectorAll(this.selectors.form)).map(
      (form, index) => {
        form.id = form.id || `${this.name}-form-${index}`;
        return new FormDataFromTables(`#${form.id}`);
      }
    );
    this.initEventListeners();
    this.setDefaultDate();
    this.resetLabelColors(this.getFormFields());
  }

  initEventListeners() {
    const events = [
      [this.selectors.yesterdayButton, this.handleYesterdayButtonClick],
      [this.selectors.fridayButton, this.handleFridayButtonClick],
      [this.selectors.todayButton, this.handleTodayButtonClick],
    ];

    events.forEach(([selector, handler]) => {
      const elements = this.container.querySelectorAll(selector);
      elements.forEach((element) => {
        element.addEventListener('click', (event) => handler.call(this, event));
      });
    });
  }

  setDefaultDate() {
    const dateInputs = this.container.querySelectorAll(this.selectors.dateInput);
    dateInputs.forEach((dateInput) => {
      const today = new Date();
      dateInput.value = today.toISOString().split('T')[0];
    });
    this.updateLabelColors(this.getFormFields());
  }

  handleYesterdayButtonClick(event) {
    this.setDate('yesterday');
    this.updateLabelColors(this.getFormFields());
    this.eventHandlers.yesterdayButton?.(event);
  }

  handleFridayButtonClick(event) {
    this.setDate('friday');
    this.updateLabelColors(this.getFormFields());
    this.eventHandlers.fridayButton?.(event);
  }

  handleTodayButtonClick(event) {
    this.setDate('today');
    this.updateLabelColors(this.getFormFields());
    this.eventHandlers.todayButton?.(event);
  }

  setDate(type) {
    const dateInputs = this.container.querySelectorAll(this.selectors.dateInput);
    dateInputs.forEach((dateInput) => {
      let targetDate = new Date();
      if (type === 'yesterday') {
        targetDate.setDate(targetDate.getDate() - 1);
      } else if (type === 'friday') {
        while (targetDate.getDay() !== 5) {
          targetDate.setDate(targetDate.getDate() - 1);
        }
      }
      dateInput.value = targetDate.toISOString().split('T')[0];
    });
  }

  updateLabelColors(fields) {
    Object.entries(fields).forEach(([key, id]) => {
      const input = this.container.querySelector(`#${id}`);
      const label = this.container.querySelector(`label[for="${id}"]`);
      if (!input || !label) return;
      if (['date', 'costPrivat', 'forma'].includes(key)) {
        label.style.color = this.colors.errorColor;
      } else {
        label.style.removeProperty('color');
      }
    });
  }

  resetLabelColors(fields) {
    this.updateLabelColors(fields);
  }

  clearForm() {
    const fields = this.getFormFields();
    const fieldsToClear = [
      fields.summa,
      fields.summaPrivat,
      fields.firmaArrivalWaste,
      fields.waste,
      fields.termkar,
      fields.sftermkar,
    ];

    fieldsToClear.forEach((id) => {
      const element = this.container.querySelector(`#${id}`);
      if (element) element.value = '';
    });

    this.updateLabelColors(this.getFormFields());
  }
}

</script>