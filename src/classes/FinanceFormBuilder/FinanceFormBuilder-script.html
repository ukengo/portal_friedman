<script>

  class FinanceFormBuilder {

    attributes = {
      modContainerAttribute: 'data-cashe-rom-mod-container',
      casheFinOverlayAttribute: 'cashe-fin-overlay',
    }

    selectors = {
      blockPlusMinus: '[data-js-fin-button-plus-minus]',
      financeContainer: '[data-cashe-rom-finance-container]',
      financeModContainer: '[finance-mod-container]',
      modContainer: `[${this.attributes.modContainerAttribute}]`,
      buttonPlus: '[data-js-fin-button-plus]',
      buttonPMinus: '[data-js-fin-button-minus]',
      buttonAdd: '[data-js-fin-button-add]',
      buttonMod: '[data-js-fin-button-mod]',
      casheFinOverlay: `[${this.attributes.casheFinOverlayAttribute}]`,
      nameSummafin: '[name="summafin"]',
      namePriznakfin: '[name="priznakfin"]',
      nameDateoplfin: '[name="dateoplfin"]',
      dateRegular: '[data-date-regular]',
      dateRegularPlus: '[data-date-regular-plus]',
      dateRegularMinus: '[data-date-regular-minus]',
    }

    colors = {
      borderTopColor: '#dee2e6'
    }

    static arrFinMulti = [];

    constructor(name, templateSelector, containerSelector) {
      this.name = name;
      this.templateSelector = templateSelector;
      this.containerSelector = containerSelector;
      this.template = document.querySelector(templateSelector);
      this.container = document.querySelector(containerSelector);
    }

    build() {

      if (this.template && this.container) {
        const clone = this.template.content.cloneNode(true);
        this.container.appendChild(clone);
        this.name != 'finance' && this.addIdToElements('input, select, datalist, button');
        this.addClassToForm();
        const instance = new FormDataFromTables(`.form-fin-start-${this.name}`);

        // При фокусі на сумі автовставлення ознаки
        instance.inputToFocus(this.selectors.nameSummafin, this.selectors.namePriznakfin, 'гот');

        // При фокусі на даті вставляємо вчорашню
        instance.todayDate(this.selectors.nameDateoplfin);

        // регулювання дати у вікні пошуку
        instance.datePlusMinusDays(this.selectors.nameDateoplfin, this.selectors.dateRegular, this.selectors.dateRegularPlus, this.selectors.dateRegularMinus);

        // вішаємо подію на кнопку  Clear Record
        this.buttonsClearFinanceEvents(instance);

        // вішаємо події на кнопки +, --, Add
        this.btnPlusMinus = this.container.querySelectorAll(this.selectors.blockPlusMinus);
        this.btnAdd = this.container.querySelector(this.selectors.buttonAdd);
        this.buttonsMultipleFinancePlusMinus(instance, this.btnPlusMinus, this.btnAdd);

        // вішаємо події на кнопку Mod 
        this.btnMod = this.container.querySelector(this.selectors.buttonMod);
        this.buttonMultipleFinanceMod(this.btnMod)
        this.btnAdd.innerText = 'Add (' + FinanceFormBuilder.arrFinMulti.length + ')';
        this.buttonMultipleFinanceAdd();
      } else {
        console.error('Template or container not found');
      }
    }

    none() {
      if (this.container) {
        this.container.innerHTML = '';
      } else {
        console.error('Template or container not found');
      }
    }

    addIdToElements(elements) {
      const collection = this.container.querySelectorAll(elements);
      collection.forEach((element, index) => {
        if (element.id) {
          const id = `${element.id}-${this.name}`;
          element.id = id;
          if (element.tagName == 'INPUT' || element.tagName == 'SELECT') {
            const label = element.previousElementSibling;
            if (label) label.htmlFor = id;
          }
        }
      });
    }

    // add class to element "form"
    addClassToForm() {
      const elementForm = this.container.querySelector('form');
      const elementFormClassList = elementForm.classList.toString();
      elementForm.classList.add(`${elementFormClassList}-${this.name}`);
    }

    //---події на кнопках--------------------------------/

    // Clear Record
    buttonsClearFinanceEvents(instance) {
      let btnClearFinanceId = '#btnClearFinance'
      btnClearFinanceId = this.name !== 'finance' ? `#btnClearFinance-${this.name}` : `#btnClearFinance`;
      this.container.querySelector(btnClearFinanceId).addEventListener('click', () => instance.clearRecords());
    }

    // +/-
    buttonsMultipleFinancePlusMinus(instance, btnPlusMinus, btnAdd) {
      btnPlusMinus.forEach((btn, index) => {
        btn.addEventListener('click', e => {
          let obj = instance.formaDataObj();

          //якщо стаття витрат, то міняємо знак на мінус
          if (obj.proektfin) {
            obj.summafin *= (e.target.hasAttribute('data-js-fin-button-minus') ? -1 : +1);
            FinanceFormBuilder.arrFinMulti.push(obj);
            btnAdd.innerText = 'Add (' + FinanceFormBuilder.arrFinMulti.length + ')';
          }
        })
      })
    }

    // Add
    buttonMultipleFinanceAdd() {
      this.btnAdd.addEventListener('click', () => {
        if (this.constructor.arrFinMulti && this.constructor.arrFinMulti.length) {
          this.btnAdd.disabled = true;
          this.btnAdd.innerText = 'Add (' + this.constructor.arrFinMulti.length + ')';
          google.script.run.withSuccessHandler(() => {
            google.script.run.withSuccessHandler((data) => {
              localStorage.setItem('dataFin', JSON.stringify(data));
            }).getRecordsFin();
            this.constructor.arrFinMulti = [];
            this.btnAdd.innerText = 'Add';
            this.btnAdd.disabled = false;
            btnTableFinance();
          }).AddRecordFinMultiple(this.constructor.arrFinMulti);
        } else {
          this.btnAdd.innerText = 'Add';
          this.btnAdd.disabled = false;
        }
      })
    }

    // Mod
    // Обробник події для кнопки "Mod" — відкриває/закриває модальне вікно з таблицею
    buttonMultipleFinanceMod(btnAdd) {
      // Додаємо слухач подій до кнопки btnAdd для обробки кліку
      btnAdd.addEventListener('click', (event) => {
        // Отримуємо найближчий батьківський елемент із атрибутом [fin-buttons-block]
        const parentElement = event.currentTarget.closest('[fin-buttons-block]');
        // Знаходимо наступний сусідній елемент, який є контейнером для фінансових даних
        const financeContainer = parentElement.nextElementSibling;

        // Перевіряємо, чи існує financeContainer, якщо ні — виводимо помилку в консоль і завершуємо виконання
        if (!financeContainer) {
          console.error('Найближчий financeContainer не знайдено');
          return;
        }

        // Шукаємо контейнер для модифікацій (modContainer) всередині financeContainer за допомогою селектора
        let modContainer = financeContainer.querySelector(this.selectors.modContainer);

        // Перевіряємо, чи масив arrFinMulti порожній; якщо так — показуємо alert і повертаємо false
        if (!this.constructor.arrFinMulti.length) {
          alert('Пусто');
          return false;
        }

        // Якщо modContainer вже існує
        if (modContainer) {
          // Перемикаємо видимість modContainer: з 'none' на 'block' або навпаки
          modContainer.style.display = modContainer.style.display === 'none' ? 'block' : 'none';
          // Шукаємо існуючий оверлей у financeContainer
          const existingOverlay = financeContainer.querySelector(this.selectors.casheFinOverlay);

          // Якщо modContainer видимий і оверлей ще не створено, викликаємо рендеринг оверлею
          if (modContainer.style.display === 'block' && !existingOverlay) {
            this.renderOverlay(modContainer, financeContainer);
          }
          // Якщо modContainer прихований і оверлей існує, видаляємо оверлей
          else if (modContainer.style.display === 'none' && existingOverlay) {
            existingOverlay.remove();
          }
        }
        // Якщо modContainer ще не існує, створюємо його
        else {
          // Створюємо новий div-елемент для modContainer
          modContainer = document.createElement('div');
          // Встановлюємо атрибут modContainerAttribute для ідентифікації
          modContainer.setAttribute(this.attributes.modContainerAttribute, '');
          // Робимо контейнер видимим за замовчуванням
          modContainer.style.display = 'block';
          // Викликаємо рендеринг оверлею для нового контейнера
          this.renderOverlay(modContainer, financeContainer);
          // Додаємо modContainer до financeContainer
          financeContainer.appendChild(modContainer);

          // Створюємо нову таблицю типу CreateTableCross з даними з arrFinMulti
          const tableMod = new CreateTableCross(this.constructor.arrFinMulti, this.selectors.modContainer, this);
          // Створюємо тіло таблиці
          tableMod.createTableBodyCross();
          // Додаємо обробники подій для кнопок у таблиці
          tableMod.eventButtonsCross();
          // Додаємо класи для стилізації таблиці (Bootstrap класи + власний)
          tableMod.table.classList.add('table', 'mt-3', 'table-bordered', 'table-hover', 'table-line-selection');

          // Знаходимо оверлей у financeContainer для подальшого використання
          const casheFinOverlay = financeContainer.querySelector(this.selectors.casheFinOverlay);

          // Створюємо нову кнопку "Clear" за допомогою класу Button
          new Button({
            text: 'Clear', // Текст кнопки
            classes: ['btn', 'btn-danger'], // Класи для стилізації (Bootstrap)
            onClick: (event) => { // Обробник кліку по кнопці
              // Очищаємо масив arrFinMulti
              this.constructor.arrFinMulti.length = 0;
              // Видаляємо modContainer із DOM
              modContainer.remove();
              // Оновлюємо текст кнопки btnAdd, додаючи кількість елементів у масиві (0)
              this.btnAdd.innerText = 'Add (' + this.constructor.arrFinMulti.length + ')';

              // Перевіряємо, чи існує оверлей, і видаляємо його, якщо є
              const overlayToRemove = financeContainer.querySelector(this.selectors.casheFinOverlay);
              if (overlayToRemove) {
                overlayToRemove.remove();
              }
            },
            // Вказуємо, куди додати кнопку — у modContainer
            parentElement: financeContainer.querySelector(this.selectors.modContainer),
          });
        }

        // Налаштовуємо обробник для клавіші Escape, щоб закривати modContainer
        this.setupEscapeHandler(modContainer);
      });
    }

    // Метод для створення оверлею, який закриває модальне вікно при кліку поза ним
    renderOverlay(modContainer, financeContainer) {
      // Перевіряємо, чи оверлей уже існує, щоб уникнути дублювання
      let overlay = financeContainer.querySelector(this.selectors.casheFinOverlay);
      if (!overlay) {
        // Якщо оверлею немає, створюємо новий
        overlay = document.createElement('div');
        overlay.classList.add('cashe-fin-overlay'); // Додаємо стилі оверлею
        overlay.setAttribute(this.attributes.casheFinOverlayAttribute, ''); // Встановлюємо атрибут для пошуку

        // Додаємо подію для закриття модального вікна при кліку на оверлей
        overlay.addEventListener('mousedown', () => {
          overlay.remove(); // Видаляємо оверлей
          modContainer.style.display = 'none'; // Ховаємо модальне вікно (не видаляємо, щоб можна було відкрити знову)
        });

        // Додаємо оверлей до financeContainer
        financeContainer.appendChild(overlay);
      }
    }

    // Налаштування обробника клавіші Escape для закриття модального вікна
    setupEscapeHandler(modContainer) {
      // Створюємо функцію-обробник для клавіші Escape
      const escapeHandler = (event) => {
        if (event.key === 'Escape' || event.keyCode === 27) {
          // Перевіряємо, чи модальне вікно видиме
          if (modContainer && modContainer.style.display !== 'none') {
            event.preventDefault(); // Зупиняємо стандартну поведінку браузера
            event.stopPropagation(); // Зупиняємо поширення події
            modContainer.style.display = 'none'; // Ховаємо модальне вікно
            // Знаходимо і видаляємо оверлей, якщо він є
            const overlay = document.querySelector(this.selectors.casheFinOverlay);
            if (overlay) overlay.remove();
          }
        }
      };

      // Видаляємо старий обробник Escape, якщо він був доданий раніше
      document.removeEventListener('keydown', escapeHandler);

      // Додаємо новий обробник до document для глобального відстеження Escape
      document.addEventListener('keydown', escapeHandler);
    }
    //---події на кнопках--END---------------------------/

    borderTopOn() {
      this.container.style.borderTop = `1px solid ${this.colors.borderTopColor}`
    }

    borderTopOff() {
      this.container.style.borderTop = `0`
    }

  }








</script>